<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Particle Photon software: src/2020_photon_code.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Particle Photon software
   &#160;<span id="projectnumber">2.0</span>
   </div>
   <div id="projectbrief">Main program and libraries used on the EV chargers&#39; Particle Photons</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('2020__photon__code_8cpp_source.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">2020_photon_code.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="2020__photon__code_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/******************************************************/</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">//       THIS IS A GENERATED FILE - DO NOT EDIT       //</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">/******************************************************/</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <a class="code" href="_particle_8h.html">&quot;Particle.h&quot;</a></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">line</span> 1 <span class="stringliteral">&quot;d:/UNI_S5/new_particle_code/2020_photon_code/src/2020_photon_code.ino&quot;</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <span class="preprocessor">&lt;</span><span class="preprocessor">MQTT</span><span class="preprocessor">.</span><span class="preprocessor">h</span><span class="preprocessor">&gt;</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <span class="preprocessor">&lt;</span><span class="preprocessor">MFRC522</span><span class="preprocessor">.</span><span class="preprocessor">h</span><span class="preprocessor">&gt;</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <a class="code" href="_commandparser_8h.html">&quot;Commandparser.h&quot;</a></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <span class="preprocessor">&lt;</span><span class="preprocessor">JsonParserGeneratorRK</span><span class="preprocessor">.</span><span class="preprocessor">h</span><span class="preprocessor">&gt;</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment">//#include &quot;RFIDfunctions.h&quot;</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment">//extern void setupread();</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">line</span> 10 <span class="stringliteral">&quot;d:/UNI_S5/new_particle_code/2020_photon_code/src/2020_photon_code.ino&quot;</span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="keywordtype">int</span> <a class="code" href="2020__photon__code_8cpp.html#aea090791790fbe9e0f56d324c8eefa80">resetOlimex</a>(<a class="code" href="class_string.html">String</a> input);</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="keywordtype">int</span> <a class="code" href="2020__photon__code_8cpp.html#adc2cf5dea5b7775d53532f2ccfa10f4c">WifiSignal</a>(<a class="code" href="class_string.html">String</a> input);</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="keywordtype">int</span> <a class="code" href="2020__photon__code_8cpp.html#ad62b79073819df234fbe97fd477a2c83">resetParticle</a>(<a class="code" href="class_string.html">String</a> input);</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="keywordtype">int</span> <a class="code" href="2020__photon__code_8cpp.html#ad7dc0d6376ca803542168e9adc0dec79">progModeOlmx</a>(<a class="code" href="class_string.html">String</a> input);</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="keywordtype">void</span> <a class="code" href="2020__photon__code_8cpp.html#acd7da18abdd273f892ec13cb726810b6">blinkRFIDled</a>(<span class="keywordtype">int</span> charger,<span class="keywordtype">int</span> action);</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="keywordtype">int</span> <a class="code" href="2020__photon__code_8cpp.html#a18aecc3313a2e8b7a2a4d49759585f63">activeCharger</a>();</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="keywordtype">int</span> <a class="code" href="2020__photon__code_8cpp.html#ad0790b5517da1ecc7d9b128f1c5876a5">switchTest</a>(<a class="code" href="class_string.html">String</a> valueString);</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="keywordtype">int</span> <a class="code" href="2020__photon__code_8cpp.html#aa95a87dbf10d08c2472e2060115a786d">maxCurrentC1</a>(<a class="code" href="class_string.html">String</a> setPointStr);</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="keywordtype">int</span> <a class="code" href="2020__photon__code_8cpp.html#a33435c28a8a11141750280aec8f15cbd">maxCurrentC2</a>(<a class="code" href="class_string.html">String</a> setPointStr);</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="keywordtype">int</span> <a class="code" href="2020__photon__code_8cpp.html#acb83be59c559528f5aff6a05e307aba0">maxCurrentC1_test</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> setPoint);</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="keywordtype">int</span> <a class="code" href="2020__photon__code_8cpp.html#aec0df453c6114acf2314a61fa0879eb7">maxCurrentC2_test</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> setPoint);</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<a class="code" href="class_string.html">String</a> <a class="code" href="2020__photon__code_8cpp.html#a9e8e91d801c5f9812d2862fcc94153b3">getUserIdAtSocket</a>(<span class="keywordtype">int</span> socket);</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="keywordtype">void</span> <a class="code" href="2020__photon__code_8cpp.html#a3019b040c98717baa7b6048ac7a35dd7">allowUser_callback</a>(byte* payload, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> length);</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="keywordtype">int</span> <a class="code" href="2020__photon__code_8cpp.html#abc7cbbf081849eefdbf3b2a2a5b63151">initRFID</a>(<a class="code" href="class_string.html">String</a> input);</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="keywordtype">bool</span> <a class="code" href="2020__photon__code_8cpp.html#a1b9d7ee6530be2853b10dee40dc3c02c">readRFIDCard</a>(<span class="keywordtype">int</span> Charger);</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="keywordtype">void</span> <a class="code" href="2020__photon__code_8cpp.html#a4fc01d736fe50cf5b977f755b675f11d">setup</a>();</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="keywordtype">void</span> <a class="code" href="2020__photon__code_8cpp.html#afe461d27b9c48d5921c00d521181f12f">loop</a>();</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="_commandparser_8h.html#a37df00aa4f5618514442945d509f5029">readSerialOlimex</a>();</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="keyword">extern</span> <span class="keywordtype">bool</span> <a class="code" href="2020__photon__code_8cpp.html#a1b9d7ee6530be2853b10dee40dc3c02c">readRFIDCard</a>(<span class="keywordtype">int</span> Charger);</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="keyword">extern</span> <span class="keywordtype">float</span> <a class="code" href="_commandparser_8h.html#ac7a5502c6bab0b1b7f3e1bd58546eb1e">Current</a>[2][3];</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="keyword">extern</span> <span class="keywordtype">float</span> <a class="code" href="_commandparser_8h.html#ae0a1c20c390eb592307c92aa588bd232">Power</a>[2][3];</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="keyword">extern</span> <span class="keywordtype">float</span> <a class="code" href="_commandparser_8h.html#a5455bcadf3414330eeedd39d97e8aee2">PhaseVoltage</a>[2][3];</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="keyword">extern</span> <span class="keywordtype">float</span> <a class="code" href="_commandparser_8h.html#a97cf7b62d84c77183146053465157cdc">LineVoltage</a>[2][3];</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="keyword">extern</span> <span class="keywordtype">float</span> <a class="code" href="_commandparser_8h.html#aee63a73e17fd417c7562f2e5d7c81cb8">Energy</a>[2];</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="keyword">extern</span> <span class="keywordtype">float</span> <a class="code" href="_commandparser_8h.html#ad8ee7ca82dcb110d2d5e32d73116b001">Frequency</a>[2];</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="keyword">extern</span> <span class="keywordtype">float</span> <a class="code" href="_commandparser_8h.html#acd950d6d9d76947b74823343a5f4a25d">CurrentList</a>[20];</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="_commandparser_8h.html#ab804d1dfcf90d1a4adf1b6417583e014">numberOfZeroReadings</a>[2];</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="keywordtype">void</span> <a class="code" href="2020__photon__code_8cpp.html#a3b8259e6f263afa75396d3f65d194a92">reconnect</a>(<span class="keywordtype">void</span>);</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="keywordtype">void</span> <a class="code" href="2020__photon__code_8cpp.html#ac3a129f66dc859e2b7279565f4e1de78">callback</a>(<span class="keywordtype">char</span>* topic, byte* payload, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> length);</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="keywordtype">void</span> <a class="code" href="2020__photon__code_8cpp.html#a4c5d5ea4f6d4b65954431d96e299d9bf">charToString</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> in[], <a class="code" href="class_string.html">String</a> &amp;out);</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="keywordtype">void</span> <a class="code" href="2020__photon__code_8cpp.html#a63ba3c80c4eecc57f8ee73e2045b372f">getMeasure_callback</a>(byte* payload, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> length);</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="comment">//! var to hold last swiped RFID tag at first socket</span></div><div class="line"><a name="l00052"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#aa30c831d7117c1442287526570a90c20">   52</a></span>&#160;<a class="code" href="class_string.html">String</a> <a class="code" href="2020__photon__code_8cpp.html#aa30c831d7117c1442287526570a90c20">latestUID1</a>=<span class="stringliteral">&quot;No ID&quot;</span>;</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="comment">//! var to hold last swiped RFID tag at second socket</span></div><div class="line"><a name="l00054"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#a4183b3a07abe46eb609ddd3bbc39ce3c">   54</a></span>&#160;<a class="code" href="class_string.html">String</a> <a class="code" href="2020__photon__code_8cpp.html#a4183b3a07abe46eb609ddd3bbc39ce3c">latestUID2</a>=<span class="stringliteral">&quot;No ID&quot;</span>;</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="comment">//! var to hold valid RFID tag at first socket (used for Measurements)</span></div><div class="line"><a name="l00056"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#ad7696488afa62029edaf7487c0c32979">   56</a></span>&#160;<a class="code" href="class_string.html">String</a> <a class="code" href="2020__photon__code_8cpp.html#ad7696488afa62029edaf7487c0c32979">UIDtagCharger1</a>=<span class="stringliteral">&quot;No ID&quot;</span>;</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="comment">//! var to hold valid RFID tag at second socket (used for Measurements)</span></div><div class="line"><a name="l00058"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#ae42c45149b41b8f8cee744bb45a607ea">   58</a></span>&#160;<a class="code" href="class_string.html">String</a> <a class="code" href="2020__photon__code_8cpp.html#ae42c45149b41b8f8cee744bb45a607ea">UIDtagCharger2</a>=<span class="stringliteral">&quot;No ID&quot;</span>;</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="comment">//! constant that sets for which Photon this program is intended</span></div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="comment">/*!</span></div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="comment">    For Photon 1 set it to 0, for Photon 2 set to 2. Any more and program would need to be edited.</span></div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="comment">*/</span></div><div class="line"><a name="l00064"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#aff16429df21a43a886f66fdbc1e850a1">   64</a></span>&#160;<span class="preprocessor">#</span><span class="preprocessor">define</span> <span class="preprocessor">CHARGEROFFSET</span> 0 <span class="comment">//use 0 for socket 1&amp;2, or 2 for socket 3&amp;4, etc.</span></div><div class="line"><a name="l00065"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#acbc24b500df51b97ae92c398a78f2257">   65</a></span>&#160;<span class="preprocessor">#</span><span class="preprocessor">define</span> <span class="preprocessor">DEBUGPORT</span> <span class="preprocessor">Serial</span></div><div class="line"><a name="l00066"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#aa62b9ad8e9fe9cb8780b8f27c509baaf">   66</a></span>&#160;<span class="preprocessor">#</span><span class="preprocessor">define</span> <span class="preprocessor">SIZEOFUSERLIST</span> 2</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="comment">//#define NUMBEROFMETERS 5</span></div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="comment">//SYSTEM_MODE(SEMI_AUTOMATIC);</span></div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;</div><div class="line"><a name="l00070"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#a1e87c855c31041a5f4bca41f110ecb23">   70</a></span>&#160;<span class="preprocessor">#</span><span class="preprocessor">define</span> <span class="preprocessor">SS_PIN_CHARGER1</span> <span class="preprocessor">A1</span></div><div class="line"><a name="l00071"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#a5cb1ec604593003ff86b9e36162aeb1a">   71</a></span>&#160;<span class="preprocessor">#</span><span class="preprocessor">define</span> <span class="preprocessor">SS_PIN_CHARGER2</span> <span class="preprocessor">A2</span></div><div class="line"><a name="l00072"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#a36932b0e869e0114f32e255f61306d6b">   72</a></span>&#160;<span class="preprocessor">#</span><span class="preprocessor">define</span> <span class="preprocessor">RST_PIN</span> <span class="preprocessor">A0</span></div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;<span class="comment">//Additional UART port not possible on D1,D2??</span></div><div class="line"><a name="l00074"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#a7466c8664394caedeaf8797c447f296a">   74</a></span>&#160;<span class="preprocessor">#</span><span class="preprocessor">define</span> <span class="preprocessor">EXTRA_DIGITAL_BREAKOUT_1</span> <span class="preprocessor">D0</span> <span class="comment">// Not used yet</span></div><div class="line"><a name="l00075"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#a9ef1c29e6e7bcbc882a9516aa991450c">   75</a></span>&#160;<span class="preprocessor">#</span><span class="preprocessor">define</span> <span class="preprocessor">EXTRA_DIGITAL_BREAKOUT_2</span> <span class="preprocessor">D1</span> <span class="comment">// Not used yet</span></div><div class="line"><a name="l00076"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#a43dce6a6e56f62f028f06dffd7731dbd">   76</a></span>&#160;<span class="preprocessor">#</span><span class="preprocessor">define</span> <span class="preprocessor">EXTRA_DIGITAL_BREAKOUT_3</span> <span class="preprocessor">D3</span> <span class="comment">// Not used yet</span></div><div class="line"><a name="l00077"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#a67e476f839a040379490a06939ebac31">   77</a></span>&#160;<span class="preprocessor">#</span><span class="preprocessor">define</span> <span class="preprocessor">WAKEUP_OLIMEX</span> <span class="preprocessor">D2</span> <span class="comment">//needed for in system programming (ISP)</span></div><div class="line"><a name="l00078"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#ac12b65d6887bad87a0b5a519bba88dbe">   78</a></span>&#160;<span class="preprocessor">#</span><span class="preprocessor">define</span> <span class="preprocessor">RESET_OLIMEX</span> <span class="preprocessor">D4</span> <span class="comment">//needed for in system programming (ISP)</span></div><div class="line"><a name="l00079"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#a17398a9ea4c977d65d45016629ac4b62">   79</a></span>&#160;<span class="preprocessor">#</span><span class="preprocessor">define</span> <span class="preprocessor">PILOT_FEEDBACK_CAR_1</span> <span class="preprocessor">A6</span> <span class="comment">// To read the feedback signal from EV shield in paralel with the Olimex</span></div><div class="line"><a name="l00080"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#a5f0a51ff733ab3850f902312bc66e821">   80</a></span>&#160;<span class="preprocessor">#</span><span class="preprocessor">define</span> <span class="preprocessor">PILOT_FEEDBACK_CAR_2</span> <span class="preprocessor">A7</span> <span class="comment">// To read the feedback signal from EV shield in paralel with the Olimex</span></div><div class="line"><a name="l00081"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#ad9c4f7d10f64d91b939705d74023b303">   81</a></span>&#160;<span class="preprocessor">#</span><span class="preprocessor">define</span> <span class="preprocessor">AUTHENTICATION_CAR1</span> <span class="preprocessor">D5</span> <span class="comment">//Enable car 1 --&gt; to Olimex A2</span></div><div class="line"><a name="l00082"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#a2a2d5c06c6e46098cf951476de493799">   82</a></span>&#160;<span class="preprocessor">#</span><span class="preprocessor">define</span> <span class="preprocessor">AUTHENTICATION_CAR2</span> <span class="preprocessor">D6</span> <span class="comment">//Enable car 2 --&gt; to Olimex A3</span></div><div class="line"><a name="l00083"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#af4d98da13b92f926914c4a759759b393">   83</a></span>&#160;<span class="preprocessor">#</span><span class="preprocessor">define</span> <span class="preprocessor">EXTRA</span> <span class="preprocessor">D7</span> <span class="comment">// No function yet --&gt; to Olimex A4</span></div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;<span class="comment">//#define SERVER &quot;80.113.19.23:8080&quot;</span></div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;<span class="comment">//&quot;hannl-lmrt-particle-api.azurewebsites.net&quot;</span></div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;<a class="code" href="2020__photon__code_8cpp.html#ad474dc90a6ac368a5be5a4e0d333c8b1">STARTUP</a>(WiFi.selectAntenna(ANT_EXTERNAL)); <span class="comment">// selects the u.FL antenna //+</span></div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;<span class="comment">//SYSTEM_THREAD(ENABLED);</span></div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;<span class="comment">//MQTT setting</span></div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="comment">//byte server[] = {192,168,43,249};</span></div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;<span class="comment">//MQTT client(server, 1883, callback);</span></div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;<span class="comment">//! MQTT client details; do not set last number to over 512!</span></div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;MQTT <a class="code" href="2020__photon__code_8cpp.html#adb31c248dea8d23a099aa0dad886c3a5">client</a>(<span class="stringliteral">&quot;broker.hivemq.com&quot;</span>, 1883, <a class="code" href="_m_q_t_t_8h.html#a4f9ba980ddfd73b1a40c3513d8c5d0dd">MQTT_DEFAULT_KEEPALIVE</a>, callback, 512);</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;<span class="comment">//char ID[] = &quot;11111&quot;;</span></div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;</div><div class="line"><a name="l00098"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#a3f4173fd4828d1d948935a30e1841263">   98</a></span>&#160;<a class="code" href="class_string.html">String</a> <a class="code" href="2020__photon__code_8cpp.html#a3f4173fd4828d1d948935a30e1841263">test</a> = <span class="stringliteral">&quot;0&quot;</span>;</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;</div><div class="line"><a name="l00101"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#a617a47c70795bcff659815ad0efd2266">  101</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="2020__photon__code_8cpp.html#a617a47c70795bcff659815ad0efd2266">counter</a>=1;</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;<a class="code" href="class_m_f_r_c522.html">MFRC522</a> <a class="code" href="2020__photon__code_8cpp.html#a1777032818666232368a054cc7cc76f8">mfrc522_Charger1</a>(<a class="code" href="2020__photon__code_8cpp.html#a1e87c855c31041a5f4bca41f110ecb23">SS_PIN_CHARGER1</a>, <a class="code" href="2020__photon__code_8cpp.html#a36932b0e869e0114f32e255f61306d6b">RST_PIN</a>);   <span class="comment">// Create MFRC522 instance.</span></div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;<a class="code" href="class_m_f_r_c522.html">MFRC522</a> <a class="code" href="2020__photon__code_8cpp.html#a3dfbf949915a0daa4ff676106f605085">mfrc522_Charger2</a>(<a class="code" href="2020__photon__code_8cpp.html#a5cb1ec604593003ff86b9e36162aeb1a">SS_PIN_CHARGER2</a>, <a class="code" href="2020__photon__code_8cpp.html#a36932b0e869e0114f32e255f61306d6b">RST_PIN</a>);   <span class="comment">// Create MFRC522 instance.</span></div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="comment">//! Holds latest start of new charge if charger is in use</span></div><div class="line"><a name="l00105"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#ad9f162f714be8b69815d0a235c95c099">  105</a></span>&#160;<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="2020__photon__code_8cpp.html#ad9f162f714be8b69815d0a235c95c099">LatestStartTime</a>[2]={0,0};</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;<span class="comment">//! Holds last handled socket (0 for first socket)</span></div><div class="line"><a name="l00107"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#a9e450e39c6f4d83b30ab1c7baf55b308">  107</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="2020__photon__code_8cpp.html#a9e450e39c6f4d83b30ab1c7baf55b308">handledCharger</a>=0;</div><div class="line"><a name="l00108"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#abc87df2ac47aa12b30692fd38255d367">  108</a></span>&#160;<a class="code" href="class_string.html">String</a> <a class="code" href="2020__photon__code_8cpp.html#abc87df2ac47aa12b30692fd38255d367">ShareVar</a>;</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;<span class="comment">//String Current_Str=&quot;0&quot;;</span></div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;<span class="comment">//! var that holds the charging mode (TRUE = renewable)</span></div><div class="line"><a name="l00112"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#a570e0c09591b015ae3748de87e467b9f">  112</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="2020__photon__code_8cpp.html#a570e0c09591b015ae3748de87e467b9f">TESTCASE</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;<span class="comment">//! var that holds answer from Pi but is unused now</span></div><div class="line"><a name="l00115"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#a0cb29d1e3bc87d74d13737e494738243">  115</a></span>&#160;ushort <a class="code" href="2020__photon__code_8cpp.html#a0cb29d1e3bc87d74d13737e494738243">Pianswer</a>=0;</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;<span class="comment">//struct EMeter {</span></div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;<span class="comment">//    float PhaseVoltage[3];</span></div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;<span class="comment">//    float PhaseCurrent[3];</span></div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;<span class="comment">//    float PhasePower[3];</span></div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;<span class="comment">//    float Frequency;</span></div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;<span class="comment">//    unsigned long Time;</span></div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;<span class="comment">//};</span></div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="comment">// struct EVUser {</span></div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;<span class="comment">//     int Id;</span></div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;<span class="comment">//     String CarBrand;</span></div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;<span class="comment">//     String CarType;</span></div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;<span class="comment">//     int CarYear;</span></div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;<span class="comment">//     String Owner;</span></div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;<span class="comment">//     float BatteryCapacity;</span></div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;<span class="comment">//     String UIDtag;</span></div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;<span class="comment">//     int PendingCharger;</span></div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;<span class="comment">//     unsigned long StartTime;</span></div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;<span class="comment">// };</span></div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;<span class="comment">//EMeter EMeterData[NUMBEROFMETERS];</span></div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;<span class="comment">//EMeter EMeterData;</span></div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;<span class="comment">//``String EVListStr=&quot;&quot;;</span></div><div class="line"><a name="l00140"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#a3cc9a3f799bf2e4bf1b63ee7367911cb">  140</a></span>&#160;<a class="code" href="class_string.html">String</a> <a class="code" href="2020__photon__code_8cpp.html#a3cc9a3f799bf2e4bf1b63ee7367911cb">currentStr</a>=<span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;<span class="comment">//! Next timestamp to publish measurements in ms</span></div><div class="line"><a name="l00142"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#a4e589466e8ba636e450e90122ed59185">  142</a></span>&#160;<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="2020__photon__code_8cpp.html#a4e589466e8ba636e450e90122ed59185">nextTime</a>[2] = {30000,30000};    <span class="comment">// Next time to pub measurements</span></div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;<span class="comment">//! Deprecated function to convert char to String - the String class already has one</span></div><div class="line"><a name="l00145"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#a4c5d5ea4f6d4b65954431d96e299d9bf">  145</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="2020__photon__code_8cpp.html#a4c5d5ea4f6d4b65954431d96e299d9bf">charToString</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> in[], <a class="code" href="class_string.html">String</a> &amp;out) {</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    byte index = 0;</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span> *pointer = in;</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    out <a class="code" href="class_string.html#a0138caa55ac6d8b5bcd1fa7bb484a831">=</a> <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    <span class="keywordflow">while</span> (*pointer++) {</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;      out.concat(in[index++]);</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;      }</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;}</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;<span class="comment">//! Sends reset signal to EV charger controller</span></div><div class="line"><a name="l00156"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#aea090791790fbe9e0f56d324c8eefa80">  156</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="2020__photon__code_8cpp.html#aea090791790fbe9e0f56d324c8eefa80">resetOlimex</a>(<a class="code" href="class_string.html">String</a> input) {</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    digitalWrite(<a class="code" href="2020__photon__code_8cpp.html#ac12b65d6887bad87a0b5a519bba88dbe">RESET_OLIMEX</a>, LOW);</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    delay(500);</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    digitalWrite(<a class="code" href="2020__photon__code_8cpp.html#ac12b65d6887bad87a0b5a519bba88dbe">RESET_OLIMEX</a>, HIGH);</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;}</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;<span class="comment">//! Return wifi strength</span></div><div class="line"><a name="l00164"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#adc2cf5dea5b7775d53532f2ccfa10f4c">  164</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="2020__photon__code_8cpp.html#adc2cf5dea5b7775d53532f2ccfa10f4c">WifiSignal</a>(<a class="code" href="class_string.html">String</a> input) {</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;    <span class="keywordflow">return</span> WiFi.RSSI();</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;}</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;<span class="comment">//! Resets Photon</span></div><div class="line"><a name="l00169"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#ad62b79073819df234fbe97fd477a2c83">  169</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="2020__photon__code_8cpp.html#ad62b79073819df234fbe97fd477a2c83">resetParticle</a>(<a class="code" href="class_string.html">String</a> input) {</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    System.reset();</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;}</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;<span class="comment">//! Sets Olimex into programming mode</span></div><div class="line"><a name="l00174"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#ad7dc0d6376ca803542168e9adc0dec79">  174</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="2020__photon__code_8cpp.html#ad7dc0d6376ca803542168e9adc0dec79">progModeOlmx</a>(<a class="code" href="class_string.html">String</a> input) {</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    digitalWrite(<a class="code" href="2020__photon__code_8cpp.html#a67e476f839a040379490a06939ebac31">WAKEUP_OLIMEX</a>, HIGH);</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    delay(500);</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;    <a class="code" href="2020__photon__code_8cpp.html#aea090791790fbe9e0f56d324c8eefa80">resetOlimex</a><a class="code" href="2020__photon__code_8cpp.html#aea090791790fbe9e0f56d324c8eefa80">(</a><span class="stringliteral">&quot;&quot;</span><a class="code" href="2020__photon__code_8cpp.html#aea090791790fbe9e0f56d324c8eefa80">)</a>;</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    delay(500);</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;    digitalWrite(<a class="code" href="2020__photon__code_8cpp.html#a67e476f839a040379490a06939ebac31">WAKEUP_OLIMEX</a>, LOW);</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;}</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;<span class="comment">//! unused function to blink the Photon LED</span></div><div class="line"><a name="l00184"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#acd7da18abdd273f892ec13cb726810b6">  184</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="2020__photon__code_8cpp.html#acd7da18abdd273f892ec13cb726810b6">blinkRFIDled</a>(<span class="keywordtype">int</span> charger,<span class="keywordtype">int</span> action) {</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;    <span class="comment">//action=1  succesfull start new charge (charger is free and last stoped session &gt; 20 sec ago)</span></div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;    <span class="comment">//action=2  charger is free, but you allready swiped the card in the last 20 sec (second swipe within 20sec)</span></div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;    <span class="comment">//action=3  charger is occupied by annother user</span></div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    <span class="comment">//action=4  succesful stop this charge session</span></div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;    <span class="comment">//action=5  you just started a charge on this charger, but have another consecutive RFID read/swipe within 20 seconds</span></div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;    <span class="comment">//action=6  you are already charging at another charger</span></div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;    <span class="comment">//action=7  succesfull RFID read, but you are not in the userlist</span></div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    digitalWrite(D7,HIGH);</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    delay(100);</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    digitalWrite(D7,LOW);</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;}</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;<span class="comment">//! Return 1 if socket 1 is used, 2 if socket 2 is used, and 3 if both are in use</span></div><div class="line"><a name="l00200"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#a18aecc3313a2e8b7a2a4d49759585f63">  200</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="2020__photon__code_8cpp.html#a18aecc3313a2e8b7a2a4d49759585f63">activeCharger</a>() {</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;    <span class="keywordtype">int</span> number = 0;</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;3; i++) {</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="_commandparser_8h.html#ac7a5502c6bab0b1b7f3e1bd58546eb1e">Current</a>[0][i] &gt; 0.10) {</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;            number += 1;</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;        }</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    }</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;3; i++) {</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="_commandparser_8h.html#ac7a5502c6bab0b1b7f3e1bd58546eb1e">Current</a>[1][i] &gt; 0.10) {</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;            number += 2;</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;        }</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;    }</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    <span class="keywordflow">return</span> number;</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;}</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;<span class="comment">//! Switches between renewable mode (-input &quot;true&quot;) and manual setpoint mode</span></div><div class="line"><a name="l00220"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#ad0790b5517da1ecc7d9b128f1c5876a5">  220</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="2020__photon__code_8cpp.html#ad0790b5517da1ecc7d9b128f1c5876a5">switchTest</a>(<a class="code" href="class_string.html">String</a> valueString) {</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    <span class="keywordflow">if</span> (valueString <a class="code" href="class_string.html#ad453b9631caf5d0164ae493bf1aa9680">==</a> <span class="stringliteral">&quot;true&quot;</span>) {</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;        <a class="code" href="2020__photon__code_8cpp.html#a570e0c09591b015ae3748de87e467b9f">TESTCASE</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;        <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    }</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    <span class="keywordflow">if</span> (valueString <a class="code" href="class_string.html#ad453b9631caf5d0164ae493bf1aa9680">==</a> <span class="stringliteral">&quot;false&quot;</span>) {</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;        <a class="code" href="2020__photon__code_8cpp.html#a570e0c09591b015ae3748de87e467b9f">TESTCASE</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;        <a class="code" href="2020__photon__code_8cpp.html#aa95a87dbf10d08c2472e2060115a786d">maxCurrentC1</a><a class="code" href="2020__photon__code_8cpp.html#aa95a87dbf10d08c2472e2060115a786d">(</a><span class="stringliteral">&quot;32&quot;</span><a class="code" href="2020__photon__code_8cpp.html#aa95a87dbf10d08c2472e2060115a786d">)</a>;</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;        <a class="code" href="2020__photon__code_8cpp.html#a33435c28a8a11141750280aec8f15cbd">maxCurrentC2</a><a class="code" href="2020__photon__code_8cpp.html#a33435c28a8a11141750280aec8f15cbd">(</a><span class="stringliteral">&quot;32&quot;</span><a class="code" href="2020__photon__code_8cpp.html#a33435c28a8a11141750280aec8f15cbd">)</a>;</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    }</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;}</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;<span class="comment">//! Sets max Current output at socket 1 in manual mode</span></div><div class="line"><a name="l00234"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#aa95a87dbf10d08c2472e2060115a786d">  234</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="2020__photon__code_8cpp.html#aa95a87dbf10d08c2472e2060115a786d">maxCurrentC1</a>(<a class="code" href="class_string.html">String</a> setPointStr) {</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> setPoint = setPointStr<a class="code" href="class_string.html#a2dc5a9a787f8ff266d1130594ec65237">.</a><a class="code" href="class_string.html#a2dc5a9a787f8ff266d1130594ec65237">toInt</a><a class="code" href="class_string.html#a2dc5a9a787f8ff266d1130594ec65237">(</a><a class="code" href="class_string.html#a2dc5a9a787f8ff266d1130594ec65237">)</a>;</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    <span class="keywordflow">if</span> (setPoint &lt; 7)</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;        setPoint = 6;</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    byte olimexMessage[4] = {0xFE,1,setPoint,0xFF};</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="2020__photon__code_8cpp.html#a570e0c09591b015ae3748de87e467b9f">TESTCASE</a>) {</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;        Serial1.write(olimexMessage,4);</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;        <a class="code" href="2020__photon__code_8cpp.html#acbc24b500df51b97ae92c398a78f2257">DEBUGPORT</a>.println(<span class="stringliteral">&quot;maxCurrentC&quot;</span>+String(<a class="code" href="2020__photon__code_8cpp.html#aff16429df21a43a886f66fdbc1e850a1">CHARGEROFFSET</a>+1)+<span class="stringliteral">&quot;&gt;\tNew setpoint set at &quot;</span>+String(setPoint)+<span class="stringliteral">&quot; Amps.&quot;</span>);</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;    }</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;}</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;<span class="comment">//! Sets max Current output at socket 2 in manual mode</span></div><div class="line"><a name="l00248"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#a33435c28a8a11141750280aec8f15cbd">  248</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="2020__photon__code_8cpp.html#a33435c28a8a11141750280aec8f15cbd">maxCurrentC2</a>(<a class="code" href="class_string.html">String</a> setPointStr) {</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> setPoint = setPointStr<a class="code" href="class_string.html#a2dc5a9a787f8ff266d1130594ec65237">.</a><a class="code" href="class_string.html#a2dc5a9a787f8ff266d1130594ec65237">toInt</a><a class="code" href="class_string.html#a2dc5a9a787f8ff266d1130594ec65237">(</a><a class="code" href="class_string.html#a2dc5a9a787f8ff266d1130594ec65237">)</a>;</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;    <span class="keywordflow">if</span> (setPoint &lt; 7)</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;        setPoint = 6;</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;    byte olimexMessage[4] = {0xFE, 2, setPoint, 0xFF};</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="2020__photon__code_8cpp.html#a570e0c09591b015ae3748de87e467b9f">TESTCASE</a>) {</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;        Serial1.write(olimexMessage,4);</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;        <a class="code" href="2020__photon__code_8cpp.html#acbc24b500df51b97ae92c398a78f2257">DEBUGPORT</a>.println(<span class="stringliteral">&quot;maxCurrentC&quot;</span>+String(<a class="code" href="2020__photon__code_8cpp.html#aff16429df21a43a886f66fdbc1e850a1">CHARGEROFFSET</a>+2)+<span class="stringliteral">&quot;&gt;\tNew setpoint set at &quot;</span>+String(setPoint)+<span class="stringliteral">&quot; Amps.&quot;</span>);</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    }</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;}</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;<span class="comment">//! Sets max Current output at socket 1/3 in renewable mode and publishes new setpoint at &quot;HANevse/photonMaxC1&quot; or C3</span></div><div class="line"><a name="l00262"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#acb83be59c559528f5aff6a05e307aba0">  262</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="2020__photon__code_8cpp.html#acb83be59c559528f5aff6a05e307aba0">maxCurrentC1_test</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> setPoint) {</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;    <span class="keywordflow">if</span> (setPoint &lt; 7)</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;        setPoint = 6;</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;    byte olimexMessage[4] = {0xFE, 1, setPoint, 0xFF};</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="2020__photon__code_8cpp.html#a570e0c09591b015ae3748de87e467b9f">TESTCASE</a>) {</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;        Serial1.write(olimexMessage,4);</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;        <a class="code" href="2020__photon__code_8cpp.html#acbc24b500df51b97ae92c398a78f2257">DEBUGPORT</a>.println(<span class="stringliteral">&quot;maxCurrentC&quot;</span>+String(<a class="code" href="2020__photon__code_8cpp.html#aff16429df21a43a886f66fdbc1e850a1">CHARGEROFFSET</a>+1)+<span class="stringliteral">&quot;&gt;\tNew setpoint set at &quot;</span>+String(setPoint)+<span class="stringliteral">&quot; Amps.&quot;</span>);</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;        <a class="code" href="class_string.html">String</a> topic_str = <span class="stringliteral">&quot;HANevse/photonMaxC&quot;</span>;</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;        topic_str<a class="code" href="class_string.html#a6d437a7312b591848b5457705fee5549">.</a><a class="code" href="class_string.html#a6d437a7312b591848b5457705fee5549">concat</a><a class="code" href="class_string.html#a6d437a7312b591848b5457705fee5549">(</a><a class="code" href="2020__photon__code_8cpp.html#aff16429df21a43a886f66fdbc1e850a1">CHARGEROFFSET</a>+1<a class="code" href="class_string.html#a6d437a7312b591848b5457705fee5549">)</a>;</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;        <a class="code" href="2020__photon__code_8cpp.html#adb31c248dea8d23a099aa0dad886c3a5">client</a>.publish(topic_str, <a class="code" href="class_string.html">String</a><a class="code" href="class_string.html#a53134e2b38eb0d114f886e807a3753ae">(</a>setPoint<a class="code" href="class_string.html#a53134e2b38eb0d114f886e807a3753ae">)</a>);</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;    }</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;}</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;<span class="comment">//! Sets max Current output at socket 2/4 in renewable mode and publishes new setpoint at &quot;HANevse/photonMaxC2&quot; or C4</span></div><div class="line"><a name="l00278"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#aec0df453c6114acf2314a61fa0879eb7">  278</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="2020__photon__code_8cpp.html#aec0df453c6114acf2314a61fa0879eb7">maxCurrentC2_test</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> setPoint) {</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;    <span class="keywordflow">if</span> (setPoint &lt; 7)</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;        setPoint = 6;</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;    byte olimexMessage[4] = {0xFE,2,setPoint,0xFF};</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="2020__photon__code_8cpp.html#a570e0c09591b015ae3748de87e467b9f">TESTCASE</a>) {</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;        Serial1.write(olimexMessage,4);</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;        <a class="code" href="2020__photon__code_8cpp.html#acbc24b500df51b97ae92c398a78f2257">DEBUGPORT</a>.println(<span class="stringliteral">&quot;maxCurrentC&quot;</span>+String(<a class="code" href="2020__photon__code_8cpp.html#aff16429df21a43a886f66fdbc1e850a1">CHARGEROFFSET</a>+2)+<span class="stringliteral">&quot;&gt;\tNew setpoint set at &quot;</span>+String(setPoint)+<span class="stringliteral">&quot; Amps.&quot;</span>);</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;        <a class="code" href="class_string.html">String</a> topic_str = <span class="stringliteral">&quot;HANevse/photonMaxC&quot;</span>;</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;        topic_str<a class="code" href="class_string.html#a6d437a7312b591848b5457705fee5549">.</a><a class="code" href="class_string.html#a6d437a7312b591848b5457705fee5549">concat</a><a class="code" href="class_string.html#a6d437a7312b591848b5457705fee5549">(</a><a class="code" href="2020__photon__code_8cpp.html#aff16429df21a43a886f66fdbc1e850a1">CHARGEROFFSET</a>+2<a class="code" href="class_string.html#a6d437a7312b591848b5457705fee5549">)</a>;</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;        <a class="code" href="2020__photon__code_8cpp.html#adb31c248dea8d23a099aa0dad886c3a5">client</a>.publish(topic_str, <a class="code" href="class_string.html">String</a><a class="code" href="class_string.html#a53134e2b38eb0d114f886e807a3753ae">(</a>setPoint<a class="code" href="class_string.html#a53134e2b38eb0d114f886e807a3753ae">)</a>);</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;    }</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;}</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;<span class="comment">int AuthPinsHigh(String input)</span></div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;<span class="comment">{</span></div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;<span class="comment">    digitalWrite(AUTHENTICATION_CAR1, HIGH); //digitalWrite(D1,LOW);</span></div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;<span class="comment">    digitalWrite(AUTHENTICATION_CAR2, HIGH);//digitalWrite(D2,LOW);</span></div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;<span class="comment">    //digitalWrite(D7,HIGH);</span></div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;<span class="comment">    delay(10000);</span></div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;<span class="comment">    return 1;</span></div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;<span class="comment">}</span></div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;<span class="comment">int AuthPinsLow(String input)</span></div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;<span class="comment">{</span></div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;<span class="comment">    digitalWrite(AUTHENTICATION_CAR1, LOW); //digitalWrite(D1,LOW);</span></div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;<span class="comment">    digitalWrite(AUTHENTICATION_CAR2, LOW);//digitalWrite(D2,LOW);</span></div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;<span class="comment">    //digitalWrite(D7,LOW);</span></div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;<span class="comment">    delay(10000);</span></div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;<span class="comment">    return 1;</span></div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;<span class="comment">}*/</span></div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;<span class="comment">//! Returns RFID tag at the asked socket</span></div><div class="line"><a name="l00312"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#a9e8e91d801c5f9812d2862fcc94153b3">  312</a></span>&#160;<a class="code" href="class_string.html">String</a> <a class="code" href="2020__photon__code_8cpp.html#a9e8e91d801c5f9812d2862fcc94153b3">getUserIdAtSocket</a>(<span class="keywordtype">int</span> socket) {</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;    <span class="keywordflow">if</span> (socket == 1+<a class="code" href="2020__photon__code_8cpp.html#aff16429df21a43a886f66fdbc1e850a1">CHARGEROFFSET</a>)</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="2020__photon__code_8cpp.html#ad7696488afa62029edaf7487c0c32979">UIDtagCharger1</a>;</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;    <span class="keywordflow">if</span> (socket == 2+<a class="code" href="2020__photon__code_8cpp.html#aff16429df21a43a886f66fdbc1e850a1">CHARGEROFFSET</a>)</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="2020__photon__code_8cpp.html#ae42c45149b41b8f8cee744bb45a607ea">UIDtagCharger2</a>;</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;    <span class="keywordflow">return</span> <span class="stringliteral">&quot;00&quot;</span>;</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;}</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;<span class="comment">//! Callback function to automatically set max Currents from MQTT message if in renewable mode</span></div><div class="line"><a name="l00321"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#a63ba3c80c4eecc57f8ee73e2045b372f">  321</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="2020__photon__code_8cpp.html#a63ba3c80c4eecc57f8ee73e2045b372f">getMeasure_callback</a>(byte* payload, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> length) {</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;    <span class="comment">//int sockets = 1;</span></div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;    <span class="comment">//char p[length + 1];</span></div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;    <span class="comment">//memcpy(p, payload, length);</span></div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;    <span class="comment">//int setPoint =  (String(p)).toInt();</span></div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;    <span class="keywordtype">int</span> setP = 0;</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;    <a class="code" href="class_json_parser.html">JsonParser</a> parser1;</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;    parser1<a class="code" href="class_json_buffer.html#a70969847d857815a9ded6450378e0e53">.</a><a class="code" href="class_json_buffer.html#a70969847d857815a9ded6450378e0e53">clear</a><a class="code" href="class_json_buffer.html#a70969847d857815a9ded6450378e0e53">(</a><a class="code" href="class_json_buffer.html#a70969847d857815a9ded6450378e0e53">)</a>;</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;    parser1.addData( (<span class="keywordtype">char</span>*)(payload), length);</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;    parser1<a class="code" href="class_json_parser.html#ad528213e8600cbad4d85910b62fc033a">.</a><a class="code" href="class_json_parser.html#ad528213e8600cbad4d85910b62fc033a">parse</a><a class="code" href="class_json_parser.html#ad528213e8600cbad4d85910b62fc033a">(</a><a class="code" href="class_json_parser.html#ad528213e8600cbad4d85910b62fc033a">)</a>;</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;<span class="comment">//    parser1.getOuterValueByKey(&quot;I1&quot;, EMeterData.PhaseCurrent[0]);</span></div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;<span class="comment">//    parser1.getOuterValueByKey(&quot;I2&quot;, EMeterData.PhaseCurrent[1]);</span></div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;<span class="comment">//    parser1.getOuterValueByKey(&quot;I3&quot;, EMeterData.PhaseCurrent[2]);</span></div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;<span class="comment">//    parser1.getOuterValueByKey(&quot;Sockets&quot;, sockets);</span></div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;    parser1.getOuterValueByKey(<span class="stringliteral">&quot;setPoint&quot;</span>, setP);</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> setPoint = setP;</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;    <span class="comment">//client.publish(&quot;HANevse/photonMax&quot;, String(setPoint));</span></div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;    <span class="comment">// if (activeCharger() != 0)</span></div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    <span class="comment">// {</span></div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;      <a class="code" href="2020__photon__code_8cpp.html#acb83be59c559528f5aff6a05e307aba0">maxCurrentC1_test</a><a class="code" href="2020__photon__code_8cpp.html#acb83be59c559528f5aff6a05e307aba0">(</a>setPoint<a class="code" href="2020__photon__code_8cpp.html#acb83be59c559528f5aff6a05e307aba0">)</a>; <span class="comment">//Emeter3, I1</span></div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;      delay(10);</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;      <a class="code" href="2020__photon__code_8cpp.html#aec0df453c6114acf2314a61fa0879eb7">maxCurrentC2_test</a><a class="code" href="2020__photon__code_8cpp.html#aec0df453c6114acf2314a61fa0879eb7">(</a>setPoint<a class="code" href="2020__photon__code_8cpp.html#aec0df453c6114acf2314a61fa0879eb7">)</a>; <span class="comment">//Emeter3, I1</span></div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;    <span class="comment">// }</span></div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;}</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;<span class="comment">// void old_getMeasure_callback(byte* payload, unsigned int length) {</span></div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;<span class="comment">//     String data;</span></div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;<span class="comment">//     unsigned int from = 0;</span></div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;<span class="comment">//     unsigned int to = 0;</span></div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;<span class="comment">//    </span></div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;<span class="comment">//     char p[length + 1];</span></div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;<span class="comment">//     memcpy(p, payload, length);</span></div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;<span class="comment">//    </span></div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;<span class="comment">//     p[length] = NULL;</span></div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;<span class="comment">//     charToString(p, data);</span></div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;<span class="comment">//     for(int i=0; i&lt;NUMBEROFMETERS; i++) {</span></div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;<span class="comment">//         //Read Phase Voltage</span></div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;<span class="comment">//         for(int j=0; j&lt;3; j++) {</span></div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;<span class="comment">//             while (data[to]!=&#39;%&#39;) {</span></div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;<span class="comment">//                 to++;</span></div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;<span class="comment">//             }</span></div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;<span class="comment">//             EMeterData[i].PhaseVoltage[j] = (data.substring(from, to)).toFloat();</span></div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;<span class="comment">//             to++;</span></div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;<span class="comment">//             from = to;</span></div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;<span class="comment">//         }</span></div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;<span class="comment">//         //Read Phase Current</span></div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;<span class="comment">//         for(int j=0; j&lt;3; j++) {</span></div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;<span class="comment">//             while (data[to]!=&#39;%&#39;) {</span></div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;<span class="comment">//                 to++;</span></div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;<span class="comment">//             }</span></div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;<span class="comment">//             EMeterData[i].PhaseCurrent[j] = (data.substring(from, to)).toFloat();</span></div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;<span class="comment">//             to++;</span></div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;<span class="comment">//             from = to;</span></div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;<span class="comment">//         }</span></div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;<span class="comment">//         //Read Phase Power</span></div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;<span class="comment">//         for(int j=0; j&lt;3; j++) {</span></div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;<span class="comment">//             while (data[to]!=&#39;%&#39;) {</span></div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;<span class="comment">//                 to++;</span></div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;<span class="comment">//             }</span></div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;<span class="comment">//             EMeterData[i].PhasePower[j] = (data.substring(from, to)).toFloat();</span></div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;<span class="comment">//             to++;</span></div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;<span class="comment">//             from = to;</span></div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;<span class="comment">//         }</span></div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;<span class="comment">//         //Read Frequency</span></div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;<span class="comment">//         while (data[to]!=&#39;%&#39;) {</span></div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;<span class="comment">//             to++;</span></div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;<span class="comment">//         }</span></div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;<span class="comment">//         EMeterData[i].Frequency = (data.substring(from, to)).toFloat();</span></div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;<span class="comment">//         to++;</span></div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;<span class="comment">//         from = to;</span></div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;<span class="comment">//         //Read StartTime</span></div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;<span class="comment">//         while (data[to]!=&#39;%&#39;) {</span></div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;<span class="comment">//             to++;</span></div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;<span class="comment">//         }</span></div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;<span class="comment">//         EMeterData[i].Time = atol((data.substring(from, to)).c_str());</span></div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;<span class="comment">//         to++;</span></div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;<span class="comment">//         from = to;</span></div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;<span class="comment">//     }</span></div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;<span class="comment">//     time_t time = Time.now();</span></div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;<span class="comment">//     //DEBUGPORT.println(time);</span></div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;<span class="comment">//     DEBUGPORT.print(&quot;MQTT&gt;\tReceive energy meter data from broker at: &quot;);</span></div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;<span class="comment">//     DEBUGPORT.println(Time.format(time, TIME_FORMAT_DEFAULT));</span></div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;<span class="comment">//    </span></div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;<span class="comment">//     //Current_Str = String((int)(EMeterData[2].PhaseCurrent[0]));</span></div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;<span class="comment">//    </span></div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;<span class="comment">//     //Send current to OLIMEX</span></div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;<span class="comment">//     /*</span></div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;<span class="comment">//     if (AUTHENTICATION_CAR1) {</span></div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;<span class="comment">//         if (AUTHENTICATION_CAR2) {</span></div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;<span class="comment">//             maxCurrentC1_test((int)(EMeterData[2].PhaseCurrent[0]/2)); //Emeter3, I1</span></div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;<span class="comment">//             maxCurrentC2_test((int)(EMeterData[2].PhaseCurrent[0]/2)); //Emeter3, I1</span></div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;<span class="comment">//         }</span></div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;<span class="comment">//         else</span></div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;<span class="comment">//             maxCurrentC1_test((int)(EMeterData[2].PhaseCurrent[0])); //Emeter3, I1</span></div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;<span class="comment">//     }</span></div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;<span class="comment">//     else {</span></div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;<span class="comment">//         if (AUTHENTICATION_CAR2) {</span></div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;<span class="comment">//             maxCurrentC2_test((int)(EMeterData[2].PhaseCurrent[0])); //Emeter3, I1</span></div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;<span class="comment">//         }</span></div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;<span class="comment">//     }</span></div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;<span class="comment">//     */</span></div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;<span class="comment">//     if (activeCharger()==1) {</span></div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;<span class="comment">//         maxCurrentC1_test((int)(EMeterData[2].PhaseCurrent[0]+EMeterData[2].PhaseCurrent[1]+EMeterData[2].PhaseCurrent[2])); //Emeter3, I1</span></div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;<span class="comment">//     }</span></div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;<span class="comment">//     else if (activeCharger()==2) {</span></div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;<span class="comment">//         maxCurrentC2_test((int)(EMeterData[2].PhaseCurrent[0]+EMeterData[2].PhaseCurrent[1]+EMeterData[2].PhaseCurrent[2])); //Emeter3, I1</span></div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;<span class="comment">//     }</span></div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;<span class="comment">//     else {</span></div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;<span class="comment">//         maxCurrentC1_test((int)((EMeterData[2].PhaseCurrent[0]+EMeterData[2].PhaseCurrent[1]+EMeterData[2].PhaseCurrent[2])/2)); //Emeter3, I1</span></div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;<span class="comment">//         maxCurrentC2_test((int)((EMeterData[2].PhaseCurrent[0]+EMeterData[2].PhaseCurrent[1]+EMeterData[2].PhaseCurrent[2])/2)); //Emeter3, I1</span></div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;<span class="comment">//     }</span></div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;<span class="comment">// }</span></div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;<span class="comment">//! Callback function to process and execute approval or denial to charge from Pi, then MQTT publish reason to website GUI</span></div><div class="line"><a name="l00443"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#a3019b040c98717baa7b6048ac7a35dd7">  443</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="2020__photon__code_8cpp.html#a3019b040c98717baa7b6048ac7a35dd7">allowUser_callback</a>(byte* payload, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> length) {</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;    <span class="keywordtype">char</span> payl[length+1];</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;    <span class="keywordtype">char</span> *endchar;</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;    memcpy(payl, payload, length);</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;    payl[length] = NULL;</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;    <span class="keywordtype">int</span> port = (<span class="keywordtype">int</span>) strtol(payl, &amp;endchar, 10);</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;    <span class="comment">//action=1  successfully start new charge (charger is free and last stopped session &gt; 20 sec ago)</span></div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;    <span class="comment">//action=2  charger is free, but you already swiped the card in the last 20 sec (second swipe within 20sec)</span></div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;    <span class="comment">//action=3  charger is occupied by another user</span></div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;    <span class="comment">//action=4  succesful stop of charge session</span></div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;    <span class="comment">//action=5  you just started a charge at this charger, but had another consecutive RFID swipe within 20 seconds</span></div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;    <span class="comment">//action=6  you are already charging at another charger</span></div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;    <span class="comment">//action=7  succesful RFID read, but you are not in the userlist</span></div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;    <span class="keywordtype">int</span> socketNr = port - 1 - <a class="code" href="2020__photon__code_8cpp.html#aff16429df21a43a886f66fdbc1e850a1">CHARGEROFFSET</a>;</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;    <a class="code" href="class_string.html">String</a> topic_str = <span class="stringliteral">&quot;HANevse/photonConverted/&quot;</span>;</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;    topic_str<a class="code" href="class_string.html#a6d437a7312b591848b5457705fee5549">.</a><a class="code" href="class_string.html#a6d437a7312b591848b5457705fee5549">concat</a><a class="code" href="class_string.html#a6d437a7312b591848b5457705fee5549">(</a>port<a class="code" href="class_string.html#a6d437a7312b591848b5457705fee5549">)</a>;</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;</div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;    endchar = endchar + 1;</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;    <span class="keywordflow">if</span> (port == (1 + <a class="code" href="2020__photon__code_8cpp.html#aff16429df21a43a886f66fdbc1e850a1">CHARGEROFFSET</a>))</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;        port = <a class="code" href="2020__photon__code_8cpp.html#ad9c4f7d10f64d91b939705d74023b303">AUTHENTICATION_CAR1</a>;</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (port == (2 + <a class="code" href="2020__photon__code_8cpp.html#aff16429df21a43a886f66fdbc1e850a1">CHARGEROFFSET</a>))</div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;        port = <a class="code" href="2020__photon__code_8cpp.html#a2a2d5c06c6e46098cf951476de493799">AUTHENTICATION_CAR2</a>;</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;        <span class="keywordflow">return</span>; <span class="comment">//port = EXTRA;</span></div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;    <span class="keywordtype">int</span> retPi = (<span class="keywordtype">int</span>) strtol(endchar, &amp;endchar, 10);</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;    <a class="code" href="2020__photon__code_8cpp.html#a0cb29d1e3bc87d74d13737e494738243">Pianswer</a> = retPi;</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;    <span class="comment">// if (Pianswer == 0)</span></div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;        <span class="comment">// Pianswer = 9;</span></div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;    <span class="keywordflow">switch</span>(retPi) {</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;        <span class="keywordflow">case</span> 1:</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;            digitalWrite(port, HIGH);</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;            LatestStartTime[socketNr] = Time.now();</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;            <span class="keywordflow">if</span> (socketNr == 0)</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;                <a class="code" href="2020__photon__code_8cpp.html#ad7696488afa62029edaf7487c0c32979">UIDtagCharger1</a><a class="code" href="class_string.html#a70b3aba8ac7a57e3bb48a52a5d64a88b">=</a><a class="code" href="2020__photon__code_8cpp.html#aa30c831d7117c1442287526570a90c20">latestUID1</a>;</div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (socketNr == 1)</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;                <a class="code" href="2020__photon__code_8cpp.html#ae42c45149b41b8f8cee744bb45a607ea">UIDtagCharger2</a><a class="code" href="class_string.html#a70b3aba8ac7a57e3bb48a52a5d64a88b">=</a><a class="code" href="2020__photon__code_8cpp.html#a4183b3a07abe46eb609ddd3bbc39ce3c">latestUID2</a>;</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;            <a class="code" href="2020__photon__code_8cpp.html#adb31c248dea8d23a099aa0dad886c3a5">client</a>.publish(topic_str, <span class="stringliteral">&quot;successful start new charge&quot;</span>);</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;        <span class="keywordflow">case</span> 2:</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;            <a class="code" href="2020__photon__code_8cpp.html#adb31c248dea8d23a099aa0dad886c3a5">client</a>.publish(topic_str, <span class="stringliteral">&quot;charger is free, but card was swiped in the last 20 sec&quot;</span>);</div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;        <span class="keywordflow">case</span> 3:</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;            <a class="code" href="2020__photon__code_8cpp.html#adb31c248dea8d23a099aa0dad886c3a5">client</a>.publish(topic_str, <span class="stringliteral">&quot;charger is occupied by another user&quot;</span>);</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;        <span class="keywordflow">case</span> 4:</div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;            digitalWrite(port, LOW);</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;            <span class="keywordflow">if</span> (socketNr == 0)</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;                <a class="code" href="2020__photon__code_8cpp.html#ad7696488afa62029edaf7487c0c32979">UIDtagCharger1</a><a class="code" href="class_string.html#a0138caa55ac6d8b5bcd1fa7bb484a831">=</a><span class="stringliteral">&quot;No ID&quot;</span>;</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (socketNr == 1)</div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;                <a class="code" href="2020__photon__code_8cpp.html#ae42c45149b41b8f8cee744bb45a607ea">UIDtagCharger2</a><a class="code" href="class_string.html#a0138caa55ac6d8b5bcd1fa7bb484a831">=</a><span class="stringliteral">&quot;No ID&quot;</span>;</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;            <a class="code" href="2020__photon__code_8cpp.html#adb31c248dea8d23a099aa0dad886c3a5">client</a>.publish(topic_str, <span class="stringliteral">&quot;successful stop charge session&quot;</span>);</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;        <span class="keywordflow">case</span> 5:</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;            <a class="code" href="2020__photon__code_8cpp.html#adb31c248dea8d23a099aa0dad886c3a5">client</a>.publish(topic_str, <span class="stringliteral">&quot;consecutive RFID swipe within 20s of new charge start&quot;</span>);</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;        <span class="keywordflow">case</span> 6:</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;            <a class="code" href="2020__photon__code_8cpp.html#adb31c248dea8d23a099aa0dad886c3a5">client</a>.publish(topic_str, <span class="stringliteral">&quot;you are already charging at another charger&quot;</span>);</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;        <span class="keywordflow">case</span> 7:</div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;            <a class="code" href="2020__photon__code_8cpp.html#adb31c248dea8d23a099aa0dad886c3a5">client</a>.publish(topic_str, <span class="stringliteral">&quot;you are in the userlist, but not verified by admin&quot;</span>);</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;        <span class="keywordflow">case</span> 8:</div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;            <a class="code" href="2020__photon__code_8cpp.html#adb31c248dea8d23a099aa0dad886c3a5">client</a>.publish(topic_str, <span class="stringliteral">&quot;successful RFID read, but you are not in the userlist&quot;</span>);</div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;        <span class="keywordflow">default</span>:</div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;            <a class="code" href="2020__photon__code_8cpp.html#adb31c248dea8d23a099aa0dad886c3a5">client</a>.publish(topic_str, <span class="stringliteral">&quot;ERROR: unknown scenario&quot;</span>);</div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;    }</div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;}</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;<span class="comment">//! Function ran for each socket every 30s in main loop to send measurements through MQTT</span></div><div class="line"><a name="l00519"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#aee241410f32d11f903417e0eb68d4bec">  519</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="2020__photon__code_8cpp.html#aee241410f32d11f903417e0eb68d4bec">add_Measurement</a>(<span class="keywordtype">float</span> phaseVoltageL1, <span class="keywordtype">float</span> phaseVoltageL2, <span class="keywordtype">float</span> phaseVoltageL3, <span class="keywordtype">float</span> currentL1, <span class="keywordtype">float</span> currentL2, <span class="keywordtype">float</span> currentL3, <span class="comment">/* float Power, float Energy,*/</span> <span class="keywordtype">float</span> Frequency, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> Timestamp, <span class="keywordtype">int</span> socketId=0, <a class="code" href="class_string.html">String</a> userId=<span class="stringliteral">&quot;00&quot;</span>) {</div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;    <span class="comment">//&lt; Filter to skip if current values are impossibly high or under 0.1A</span></div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;    <span class="comment">//if ((currentL1 &gt; 50.0)||(currentL2 &gt; 50.0)||(currentL3 &gt; 50.0)) </span></div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;    <span class="comment">//    return;</span></div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;    <span class="comment">//if ((currentL1 &lt; 0.1)&amp;&amp;(currentL2 &lt; 0.1)&amp;&amp;(currentL3 &lt; 0.1) )</span></div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;    <span class="comment">//    return;</span></div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;</div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;    <span class="comment">//This rounds floats to 3 decimal places</span></div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;    <span class="comment">// float newvar = (float)(((int)(oldvar * 1000 + .5)) / 1000); </span></div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;    <span class="comment">// phaseVoltageL1 = (float)(((int)(phaseVoltageL1 * 1000 + .5)) / 1000);</span></div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;    <span class="comment">// phaseVoltageL2 = (float)(((int)(phaseVoltageL2 * 1000 + .5)) / 1000);</span></div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;    <span class="comment">// phaseVoltageL3 = (float)(((int)(phaseVoltageL3 * 1000 + .5)) / 1000);</span></div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;    <span class="comment">// currentL1 = (float)(((int)(currentL1 * 1000 + .5)) / 1000);</span></div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;    <span class="comment">// currentL2 = (float)(((int)(currentL2 * 1000 + .5)) / 1000);</span></div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;    <span class="comment">// currentL3 = (float)(((int)(currentL3 * 1000 + .5)) / 1000);</span></div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;    <span class="comment">// Frequency = (float)(((int)(Frequency * 1000 + .5)) / 1000);</span></div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;</div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;    <a class="code" href="class_json_writer_static.html">JsonWriterStatic</a>&lt;512&gt; jsonMessage;</div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;        {</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;        <a class="code" href="class_json_writer_auto_object.html">JsonWriterAutoObject</a> obj(&amp;jsonMessage);</div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;        <span class="comment">// Add various types of data        </span></div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;        jsonMessage.insertKeyValue(<span class="stringliteral">&quot;V1&quot;</span>, phaseVoltageL1);</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;        jsonMessage.insertKeyValue(<span class="stringliteral">&quot;V2&quot;</span>, phaseVoltageL2);</div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;        jsonMessage.insertKeyValue(<span class="stringliteral">&quot;V3&quot;</span>, phaseVoltageL3);</div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;        jsonMessage.insertKeyValue(<span class="stringliteral">&quot;I1&quot;</span>, currentL1);</div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;        jsonMessage.insertKeyValue(<span class="stringliteral">&quot;I2&quot;</span>, currentL2);</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;        jsonMessage.insertKeyValue(<span class="stringliteral">&quot;I3&quot;</span>, currentL3);</div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;        <span class="comment">//jsonMessage.insertKeyValue(&quot;P&quot;, Power);</span></div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;        <span class="comment">//jsonMessage.insertKeyValue(&quot;E&quot;, Energy);</span></div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;        jsonMessage.insertKeyValue(<span class="stringliteral">&quot;F&quot;</span>, Frequency);</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;</div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;        jsonMessage.insertKeyValue(<span class="stringliteral">&quot;UserID&quot;</span>, userId);</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;        jsonMessage.insertKeyValue(<span class="stringliteral">&quot;SocketID&quot;</span>, socketId);</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;        jsonMessage.insertKeyValue(<span class="stringliteral">&quot;Time&quot;</span>, Timestamp);</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;        }</div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;3; i++) {</div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;        <span class="keywordflow">if</span>(client.publish(<span class="stringliteral">&quot;HANevse/photonMeasure&quot;</span>, jsonMessage.getBuffer())) {</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;        }</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;    }</div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;}</div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;</div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;<span class="comment">//! Initialises RFID reader</span></div><div class="line"><a name="l00567"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#abc7cbbf081849eefdbf3b2a2a5b63151">  567</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="2020__photon__code_8cpp.html#abc7cbbf081849eefdbf3b2a2a5b63151">initRFID</a>(<a class="code" href="class_string.html">String</a> input) {</div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;    <span class="comment">//additional config for debugging RFID readers</span></div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;    pinMode(<a class="code" href="2020__photon__code_8cpp.html#a1e87c855c31041a5f4bca41f110ecb23">SS_PIN_CHARGER1</a>, OUTPUT);</div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;    digitalWrite(<a class="code" href="2020__photon__code_8cpp.html#a1e87c855c31041a5f4bca41f110ecb23">SS_PIN_CHARGER1</a>, HIGH);</div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;    pinMode(<a class="code" href="2020__photon__code_8cpp.html#a5cb1ec604593003ff86b9e36162aeb1a">SS_PIN_CHARGER2</a>, OUTPUT);</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;    digitalWrite(<a class="code" href="2020__photon__code_8cpp.html#a5cb1ec604593003ff86b9e36162aeb1a">SS_PIN_CHARGER2</a>, HIGH);</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;    SPI.begin(D0);      <span class="comment">// Initiate  SPI bus</span></div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;    <span class="comment">//Particle.process();</span></div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;    delay(50);</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;    mfrc522_Charger1.PCD_Init();   <span class="comment">// Initiate MFRC522</span></div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;    delay(500);</div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;    mfrc522_Charger2.PCD_Init();   <span class="comment">// Initiate MFRC522</span></div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;    <span class="comment">//mfrc522_Charger1.PCD_SetAntennaGain(mfrc522.RxGain_max);</span></div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;    mfrc522_Charger1.PCD_SetAntennaGain(mfrc522_Charger1.RxGain_max);</div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;    mfrc522_Charger2.PCD_SetAntennaGain(mfrc522_Charger2.RxGain_max);</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;</div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;    <a class="code" href="2020__photon__code_8cpp.html#acbc24b500df51b97ae92c398a78f2257">DEBUGPORT</a>.println(<span class="stringliteral">&quot;Approach your card to the reader...&quot;</span>);</div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;    <a class="code" href="2020__photon__code_8cpp.html#acbc24b500df51b97ae92c398a78f2257">DEBUGPORT</a>.println();</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;}</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;<span class="comment">//! Checks and reads RFID tag at the asked socket, then MQTT publishes it for Pi</span></div><div class="line"><a name="l00590"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#a1b9d7ee6530be2853b10dee40dc3c02c">  590</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="2020__photon__code_8cpp.html#a1b9d7ee6530be2853b10dee40dc3c02c">readRFIDCard</a>(<span class="keywordtype">int</span> Charger) {</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;   <span class="comment">// DEBUGPORT.print(&quot;readCard&gt;\t&quot;);</span></div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;    <span class="keywordtype">bool</span> Authorized = <span class="keyword">true</span>;</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;    <a class="code" href="2020__photon__code_8cpp.html#a0cb29d1e3bc87d74d13737e494738243">Pianswer</a> = 0;</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;    <span class="keywordflow">if</span>(Charger==1+<a class="code" href="2020__photon__code_8cpp.html#aff16429df21a43a886f66fdbc1e850a1">CHARGEROFFSET</a>)</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;    {</div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;      <span class="comment">// Look for new cards</span></div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;        <span class="keywordflow">if</span> ( ! mfrc522_Charger1.PICC_IsNewCardPresent())</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;        {</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;        }</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;        <span class="comment">// Select one of the cards</span></div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;        <span class="keywordflow">if</span> ( ! mfrc522_Charger1.PICC_ReadCardSerial())</div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;        {</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;        }</div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;        <span class="comment">//Show UID on serial monitor</span></div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;        <a class="code" href="2020__photon__code_8cpp.html#acbc24b500df51b97ae92c398a78f2257">DEBUGPORT</a>.print(<span class="stringliteral">&quot;readCard&gt;\tUID tag on charger1:&quot;</span>);</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;        <a class="code" href="class_string.html">String</a> content = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;        <span class="comment">//byte letter;</span></div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;        <span class="keywordflow">for</span> (byte i = 0; i &lt; mfrc522_Charger1.uid.size; i++)</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;        {</div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;            <a class="code" href="2020__photon__code_8cpp.html#acbc24b500df51b97ae92c398a78f2257">DEBUGPORT</a>.print(mfrc522_Charger1.uid.uidByte[i] &lt; 0x10 ? <span class="stringliteral">&quot; 0&quot;</span> : <span class="stringliteral">&quot; &quot;</span>);</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;            <a class="code" href="2020__photon__code_8cpp.html#acbc24b500df51b97ae92c398a78f2257">DEBUGPORT</a>.print(mfrc522_Charger1.uid.uidByte[i], HEX);</div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;            content.concat(String(mfrc522_Charger1.uid.uidByte[i] &lt; 0x10 ? <span class="stringliteral">&quot; 0&quot;</span> : <span class="stringliteral">&quot; &quot;</span>));</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;            content.concat(String(mfrc522_Charger1.uid.uidByte[i], HEX));</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;        }</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;        <a class="code" href="class_json_writer_static.html">JsonWriterStatic</a>&lt;512&gt; jsonMessage;</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;        <span class="comment">//Authorized=testUser(content,Charger);</span></div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;        <span class="comment">//UIDtagCharger1=content.substring(1); //??? why does it start at 1?</span></div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;        <a class="code" href="2020__photon__code_8cpp.html#aa30c831d7117c1442287526570a90c20">latestUID1</a>=content<a class="code" href="class_string.html#a36b10b81c1556de6e5c63fd060347f30">.</a><a class="code" href="class_string.html#a36b10b81c1556de6e5c63fd060347f30">substring</a><a class="code" href="class_string.html#a36b10b81c1556de6e5c63fd060347f30">(</a>1<a class="code" href="class_string.html#a36b10b81c1556de6e5c63fd060347f30">)</a>;</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;        {</div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;        <a class="code" href="class_json_writer_auto_object.html">JsonWriterAutoObject</a> obj(&amp;jsonMessage);</div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;        jsonMessage.insertKeyValue(<span class="stringliteral">&quot;UserId&quot;</span>, latestUID1);</div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;        jsonMessage.insertKeyValue(<span class="stringliteral">&quot;Charger&quot;</span>, Charger);</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;        jsonMessage.insertKeyValue(<span class="stringliteral">&quot;StartTime&quot;</span>, Time.now());</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;        }</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;        client.publish(<span class="stringliteral">&quot;HANevse/updateUser&quot;</span>, jsonMessage.getBuffer());</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;    }</div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;    <span class="keywordflow">if</span>(Charger==2+<a class="code" href="2020__photon__code_8cpp.html#aff16429df21a43a886f66fdbc1e850a1">CHARGEROFFSET</a>)</div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;    {</div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;        <span class="comment">// Look for new cards</span></div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;        <span class="keywordflow">if</span> ( ! mfrc522_Charger2.PICC_IsNewCardPresent())</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;        {</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;        }</div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;        <span class="comment">// Select one of the cards</span></div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;        <span class="keywordflow">if</span> ( ! mfrc522_Charger2.PICC_ReadCardSerial())</div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;        {</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;        }</div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;        <span class="comment">//DEBUGPORT.println(&quot;Read something on charger2&quot;);</span></div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;        <span class="comment">//Show UID on serial monitor</span></div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;        <a class="code" href="2020__photon__code_8cpp.html#acbc24b500df51b97ae92c398a78f2257">DEBUGPORT</a>.print(<span class="stringliteral">&quot;readCard&gt;\tUID tag on charger2:&quot;</span>);</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;        <a class="code" href="class_string.html">String</a> content = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;        <span class="comment">//byte letter;</span></div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;        <span class="keywordflow">for</span> (byte i = 0; i &lt; mfrc522_Charger2.uid.size; i++)</div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;        {</div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;            <a class="code" href="2020__photon__code_8cpp.html#acbc24b500df51b97ae92c398a78f2257">DEBUGPORT</a>.print(mfrc522_Charger2.uid.uidByte[i] &lt; 0x10 ? <span class="stringliteral">&quot; 0&quot;</span> : <span class="stringliteral">&quot; &quot;</span>);</div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;            <a class="code" href="2020__photon__code_8cpp.html#acbc24b500df51b97ae92c398a78f2257">DEBUGPORT</a>.print(mfrc522_Charger2.uid.uidByte[i], HEX);</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;            content.concat(String(mfrc522_Charger2.uid.uidByte[i] &lt; 0x10 ? <span class="stringliteral">&quot; 0&quot;</span> : <span class="stringliteral">&quot; &quot;</span>));</div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;            content.concat(String(mfrc522_Charger2.uid.uidByte[i], HEX));</div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;        }</div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;        <span class="comment">//Authorized=testUser(content,Charger);</span></div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;        <span class="comment">//UIDtagCharger2=content.substring(1);</span></div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;        <a class="code" href="2020__photon__code_8cpp.html#a4183b3a07abe46eb609ddd3bbc39ce3c">latestUID2</a>=content<a class="code" href="class_string.html#a36b10b81c1556de6e5c63fd060347f30">.</a><a class="code" href="class_string.html#a36b10b81c1556de6e5c63fd060347f30">substring</a><a class="code" href="class_string.html#a36b10b81c1556de6e5c63fd060347f30">(</a>1<a class="code" href="class_string.html#a36b10b81c1556de6e5c63fd060347f30">)</a>;</div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;</div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;        <a class="code" href="class_json_writer_static.html">JsonWriterStatic</a>&lt;512&gt; jsonMessage;</div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;</div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;        {</div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;        <a class="code" href="class_json_writer_auto_object.html">JsonWriterAutoObject</a> obj(&amp;jsonMessage);</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;        jsonMessage.insertKeyValue(<span class="stringliteral">&quot;UserId&quot;</span>, latestUID2);</div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;        jsonMessage.insertKeyValue(<span class="stringliteral">&quot;Charger&quot;</span>, Charger);</div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;        jsonMessage.insertKeyValue(<span class="stringliteral">&quot;StartTime&quot;</span>, Time.now());</div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;        }</div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;        client.publish(<span class="stringliteral">&quot;HANevse/updateUser&quot;</span>, jsonMessage.getBuffer());</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;</div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;    }</div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;    <a class="code" href="2020__photon__code_8cpp.html#acbc24b500df51b97ae92c398a78f2257">DEBUGPORT</a>.println(<span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;    delay(500);</div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;    <span class="comment">// This whole function is not interrupted by callback() so Pianswer can&#39;t be changed in the meantime</span></div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;    <span class="comment">//client.publish(&quot;HANevse/checkupdateUser&quot;, String(Pianswer));  </span></div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;     <span class="keywordflow">return</span> Authorized;</div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;}</div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;</div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;<span class="comment">//! Main function for MQTT client to check for new messages and execute callback functions</span></div><div class="line"><a name="l00683"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#ac3a129f66dc859e2b7279565f4e1de78">  683</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="2020__photon__code_8cpp.html#ac3a129f66dc859e2b7279565f4e1de78">callback</a>(<span class="keywordtype">char</span>* topic, byte* payload, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> length) {</div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;    <a class="code" href="2020__photon__code_8cpp.html#a3f4173fd4828d1d948935a30e1841263">test</a> <a class="code" href="class_string.html#a0138caa55ac6d8b5bcd1fa7bb484a831">=</a> <span class="stringliteral">&quot;99&quot;</span>;</div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;    time_t time = Time.now();</div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;    <span class="comment">//DEBUGPORT.println(time);</span></div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;    <a class="code" href="2020__photon__code_8cpp.html#acbc24b500df51b97ae92c398a78f2257">DEBUGPORT</a>.print(<span class="stringliteral">&quot;MQTT&gt;\tCallback function is called at: &quot;</span>);</div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;    <a class="code" href="2020__photon__code_8cpp.html#acbc24b500df51b97ae92c398a78f2257">DEBUGPORT</a>.println(Time.format(time, TIME_FORMAT_DEFAULT));</div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="2020__photon__code_8cpp.html#aff16429df21a43a886f66fdbc1e850a1">CHARGEROFFSET</a>==0) {</div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;         <span class="keywordflow">if</span> (strcmp(topic, <span class="stringliteral">&quot;HANevse/allowUser&quot;</span>)==0)</div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;        {</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;            allowUser_callback(payload, length);</div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;            <span class="comment">//client.publish(&quot;HANevse/photonConverted&quot;, &quot;test photon responds&quot;);</span></div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;        }</div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;         <span class="keywordflow">if</span> ( (strcmp(topic, <span class="stringliteral">&quot;HANevse/energyMeter&quot;</span>)==0) &amp;&amp; <a class="code" href="2020__photon__code_8cpp.html#a570e0c09591b015ae3748de87e467b9f">TESTCASE</a> )</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;        {</div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;            getMeasure_callback(payload, length);</div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;            <span class="comment">//client.publish(&quot;HANevse/photonTest&quot;, &quot;test photon responds&quot;);</span></div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;        }</div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;         <span class="keywordflow">if</span> (strcmp(topic, <span class="stringliteral">&quot;HANevse/resetOlimex&quot;</span>)==0)</div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;        {</div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;            <span class="keywordtype">char</span> payl[length+1];</div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;            memcpy(payl, payload, length);</div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;            payl[length] = NULL;</div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;            <a class="code" href="2020__photon__code_8cpp.html#aea090791790fbe9e0f56d324c8eefa80">resetOlimex</a><a class="code" href="2020__photon__code_8cpp.html#aea090791790fbe9e0f56d324c8eefa80">(</a>payl<a class="code" href="2020__photon__code_8cpp.html#aea090791790fbe9e0f56d324c8eefa80">)</a>;</div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;        }</div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;         <span class="keywordflow">if</span> (strcmp(topic, <span class="stringliteral">&quot;HANevse/resetPhoton&quot;</span>)==0)</div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;        {</div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;            <a class="code" href="2020__photon__code_8cpp.html#ad62b79073819df234fbe97fd477a2c83">resetParticle</a><a class="code" href="2020__photon__code_8cpp.html#ad62b79073819df234fbe97fd477a2c83">(</a><span class="stringliteral">&quot;1&quot;</span><a class="code" href="2020__photon__code_8cpp.html#ad62b79073819df234fbe97fd477a2c83">)</a>;</div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;        }</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;         <span class="keywordflow">if</span> (strcmp(topic, <span class="stringliteral">&quot;HANevse/switchTest1&quot;</span>)==0)</div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;        {</div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;            <span class="keywordtype">char</span> payl[length+1];</div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;            memcpy(payl, payload, length);</div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;            payl[length] = NULL;</div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;            <a class="code" href="2020__photon__code_8cpp.html#ad0790b5517da1ecc7d9b128f1c5876a5">switchTest</a><a class="code" href="2020__photon__code_8cpp.html#ad0790b5517da1ecc7d9b128f1c5876a5">(</a>payl<a class="code" href="2020__photon__code_8cpp.html#ad0790b5517da1ecc7d9b128f1c5876a5">)</a>;</div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;        }</div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;         <span class="keywordflow">if</span> ((strcmp(topic, <span class="stringliteral">&quot;HANevse/maxC1&quot;</span>)==0)  &amp;&amp; !<a class="code" href="2020__photon__code_8cpp.html#a570e0c09591b015ae3748de87e467b9f">TESTCASE</a> )</div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;        {</div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;            <span class="keywordtype">char</span> payl[length+1];</div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;            memcpy(payl, payload, length);</div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;            payl[length] = NULL;</div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;            <a class="code" href="2020__photon__code_8cpp.html#aa95a87dbf10d08c2472e2060115a786d">maxCurrentC1</a><a class="code" href="2020__photon__code_8cpp.html#aa95a87dbf10d08c2472e2060115a786d">(</a>payl<a class="code" href="2020__photon__code_8cpp.html#aa95a87dbf10d08c2472e2060115a786d">)</a>;</div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;            <span class="comment">//client.publish(&quot;HANevse/photonTest&quot;, &quot;test photon responds&quot;);</span></div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;        }</div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;         <span class="keywordflow">if</span> ((strcmp(topic, <span class="stringliteral">&quot;HANevse/maxC2&quot;</span>)==0) &amp;&amp; !<a class="code" href="2020__photon__code_8cpp.html#a570e0c09591b015ae3748de87e467b9f">TESTCASE</a> )</div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;        {</div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;            <span class="keywordtype">char</span> payl[length+1];</div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;            memcpy(payl, payload, length);</div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;            payl[length] = NULL;</div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;            <a class="code" href="2020__photon__code_8cpp.html#a33435c28a8a11141750280aec8f15cbd">maxCurrentC2</a><a class="code" href="2020__photon__code_8cpp.html#a33435c28a8a11141750280aec8f15cbd">(</a>payl<a class="code" href="2020__photon__code_8cpp.html#a33435c28a8a11141750280aec8f15cbd">)</a>;</div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;            <span class="comment">//client.publish(&quot;HANevse/photonTest&quot;, &quot;test photon responds&quot;);</span></div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;        }</div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;    }</div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;    <span class="keywordflow">else</span> {</div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;         <span class="keywordflow">if</span> (strcmp(topic, <span class="stringliteral">&quot;HANevse/allowUser&quot;</span>)==0)</div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;        {</div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;            allowUser_callback(payload, length);</div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;            <span class="comment">//client.publish(&quot;HANevse/photonConverted&quot;, &quot;test photon responds&quot;);</span></div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;        }</div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;         <span class="keywordflow">if</span> ( (strcmp(topic, <span class="stringliteral">&quot;HANevse/energyMeter&quot;</span>)==0) &amp;&amp; <a class="code" href="2020__photon__code_8cpp.html#a570e0c09591b015ae3748de87e467b9f">TESTCASE</a> )</div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;        {</div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;            getMeasure_callback(payload, length);</div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;            <span class="comment">//client.publish(&quot;HANevse/photonTest&quot;, &quot;test photon responds&quot;);</span></div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;        }</div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;         <span class="keywordflow">if</span> (strcmp(topic, <span class="stringliteral">&quot;HANevse/resetOlimex&quot;</span>)==0)</div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;        {</div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;            <span class="keywordtype">char</span> payl[length+1];</div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;            memcpy(payl, payload, length);</div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;            payl[length] = NULL;</div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;            <a class="code" href="2020__photon__code_8cpp.html#aea090791790fbe9e0f56d324c8eefa80">resetOlimex</a><a class="code" href="2020__photon__code_8cpp.html#aea090791790fbe9e0f56d324c8eefa80">(</a>payl<a class="code" href="2020__photon__code_8cpp.html#aea090791790fbe9e0f56d324c8eefa80">)</a>;</div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;        }</div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;         <span class="keywordflow">if</span> (strcmp(topic, <span class="stringliteral">&quot;HANevse/resetPhoton&quot;</span>)==0)</div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;        {</div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;            <a class="code" href="2020__photon__code_8cpp.html#ad62b79073819df234fbe97fd477a2c83">resetParticle</a><a class="code" href="2020__photon__code_8cpp.html#ad62b79073819df234fbe97fd477a2c83">(</a><span class="stringliteral">&quot;1&quot;</span><a class="code" href="2020__photon__code_8cpp.html#ad62b79073819df234fbe97fd477a2c83">)</a>;</div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;        }</div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;         <span class="keywordflow">if</span> (strcmp(topic, <span class="stringliteral">&quot;HANevse/switchTest2&quot;</span>)==0)</div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;        {</div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;            <span class="keywordtype">char</span> payl[length+1];</div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;            memcpy(payl, payload, length);</div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;            payl[length] = NULL;</div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;            <a class="code" href="2020__photon__code_8cpp.html#ad0790b5517da1ecc7d9b128f1c5876a5">switchTest</a><a class="code" href="2020__photon__code_8cpp.html#ad0790b5517da1ecc7d9b128f1c5876a5">(</a>payl<a class="code" href="2020__photon__code_8cpp.html#ad0790b5517da1ecc7d9b128f1c5876a5">)</a>;</div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;        }</div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;         <span class="keywordflow">if</span> ((strcmp(topic, <span class="stringliteral">&quot;HANevse/maxC3&quot;</span>)==0)  &amp;&amp; !<a class="code" href="2020__photon__code_8cpp.html#a570e0c09591b015ae3748de87e467b9f">TESTCASE</a> )</div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;        {</div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;            <span class="keywordtype">char</span> payl[length+1];</div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;            memcpy(payl, payload, length);</div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;            payl[length] = NULL;</div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;            <a class="code" href="2020__photon__code_8cpp.html#aa95a87dbf10d08c2472e2060115a786d">maxCurrentC1</a><a class="code" href="2020__photon__code_8cpp.html#aa95a87dbf10d08c2472e2060115a786d">(</a>payl<a class="code" href="2020__photon__code_8cpp.html#aa95a87dbf10d08c2472e2060115a786d">)</a>;</div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;            <span class="comment">//client.publish(&quot;HANevse/photonTest&quot;, &quot;test photon responds&quot;);</span></div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;        }</div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;         <span class="keywordflow">if</span> ((strcmp(topic, <span class="stringliteral">&quot;HANevse/maxC4&quot;</span>)==0) &amp;&amp; !<a class="code" href="2020__photon__code_8cpp.html#a570e0c09591b015ae3748de87e467b9f">TESTCASE</a> )</div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;        {</div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;            <span class="keywordtype">char</span> payl[length+1];</div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;            memcpy(payl, payload, length);</div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;            payl[length] = NULL;</div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;            <a class="code" href="2020__photon__code_8cpp.html#a33435c28a8a11141750280aec8f15cbd">maxCurrentC2</a><a class="code" href="2020__photon__code_8cpp.html#a33435c28a8a11141750280aec8f15cbd">(</a>payl<a class="code" href="2020__photon__code_8cpp.html#a33435c28a8a11141750280aec8f15cbd">)</a>;</div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;            <span class="comment">//client.publish(&quot;HANevse/photonTest&quot;, &quot;test photon responds&quot;);</span></div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;        }</div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;    }</div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;}</div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;</div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;<span class="comment">//! Function to reconnect to MQTT server if not connected and subscribe to needed topics</span></div><div class="line"><a name="l00797"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#a3b8259e6f263afa75396d3f65d194a92">  797</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="2020__photon__code_8cpp.html#a3b8259e6f263afa75396d3f65d194a92">reconnect</a>(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;    <span class="keywordflow">while</span> (!<a class="code" href="2020__photon__code_8cpp.html#adb31c248dea8d23a099aa0dad886c3a5">client</a>.isConnected()) {</div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;        <a class="code" href="2020__photon__code_8cpp.html#acbc24b500df51b97ae92c398a78f2257">DEBUGPORT</a>.print(<span class="stringliteral">&quot;MQTT&gt;\tConnecting to MQTT broker...&quot;</span>);</div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="2020__photon__code_8cpp.html#aff16429df21a43a886f66fdbc1e850a1">CHARGEROFFSET</a>==0) {</div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="2020__photon__code_8cpp.html#adb31c248dea8d23a099aa0dad886c3a5">client</a>.connect(<span class="stringliteral">&quot;EV-Photon1&quot;</span>)) {</div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;                <a class="code" href="2020__photon__code_8cpp.html#acbc24b500df51b97ae92c398a78f2257">DEBUGPORT</a>.println(<span class="stringliteral">&quot;MQTT&gt;\tConnected&quot;</span>);</div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;                <span class="comment">//client.subscribe(&quot;HANevse/#&quot;, client.QOS2);</span></div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;                <a class="code" href="2020__photon__code_8cpp.html#adb31c248dea8d23a099aa0dad886c3a5">client</a>.subscribe(<span class="stringliteral">&quot;HANevse/energyMeter&quot;</span>); <span class="comment">//+</span></div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;                <a class="code" href="2020__photon__code_8cpp.html#adb31c248dea8d23a099aa0dad886c3a5">client</a>.subscribe(<span class="stringliteral">&quot;HANevse/allowUser&quot;</span>);</div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;</div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;                <a class="code" href="2020__photon__code_8cpp.html#adb31c248dea8d23a099aa0dad886c3a5">client</a>.subscribe(<span class="stringliteral">&quot;HANevse/resetOlimex&quot;</span>);</div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;                <a class="code" href="2020__photon__code_8cpp.html#adb31c248dea8d23a099aa0dad886c3a5">client</a>.subscribe(<span class="stringliteral">&quot;HANevse/resetPhoton&quot;</span>);</div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;                <a class="code" href="2020__photon__code_8cpp.html#adb31c248dea8d23a099aa0dad886c3a5">client</a>.subscribe(<span class="stringliteral">&quot;HANevse/switchTest1&quot;</span>);</div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;                <a class="code" href="2020__photon__code_8cpp.html#adb31c248dea8d23a099aa0dad886c3a5">client</a>.subscribe(<span class="stringliteral">&quot;HANevse/maxC1&quot;</span>);</div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;                <a class="code" href="2020__photon__code_8cpp.html#adb31c248dea8d23a099aa0dad886c3a5">client</a>.subscribe(<span class="stringliteral">&quot;HANevse/maxC2&quot;</span>);</div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;            }</div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;            <span class="keywordflow">else</span> {</div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;                <a class="code" href="2020__photon__code_8cpp.html#acbc24b500df51b97ae92c398a78f2257">DEBUGPORT</a>.println(<span class="stringliteral">&quot;MQTT&gt;\tConnection failed&quot;</span>);</div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;                <a class="code" href="2020__photon__code_8cpp.html#acbc24b500df51b97ae92c398a78f2257">DEBUGPORT</a>.println(<span class="stringliteral">&quot;MQTT&gt;\tRetrying...&quot;</span>);</div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;                delay(10000);</div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;            }</div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;        }</div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="2020__photon__code_8cpp.html#aff16429df21a43a886f66fdbc1e850a1">CHARGEROFFSET</a>==2){</div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="2020__photon__code_8cpp.html#adb31c248dea8d23a099aa0dad886c3a5">client</a>.connect(<span class="stringliteral">&quot;EV-Photon2&quot;</span>)) {</div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;                <a class="code" href="2020__photon__code_8cpp.html#acbc24b500df51b97ae92c398a78f2257">DEBUGPORT</a>.println(<span class="stringliteral">&quot;MQTT&gt;\tConnected&quot;</span>);</div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;                <span class="comment">//client.subscribe(&quot;HANevse/#&quot;, client.QOS2);</span></div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;                <a class="code" href="2020__photon__code_8cpp.html#adb31c248dea8d23a099aa0dad886c3a5">client</a>.subscribe(<span class="stringliteral">&quot;HANevse/energyMeter&quot;</span>); <span class="comment">//+</span></div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;                <a class="code" href="2020__photon__code_8cpp.html#adb31c248dea8d23a099aa0dad886c3a5">client</a>.subscribe(<span class="stringliteral">&quot;HANevse/allowUser&quot;</span>);</div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;</div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;                <a class="code" href="2020__photon__code_8cpp.html#adb31c248dea8d23a099aa0dad886c3a5">client</a>.subscribe(<span class="stringliteral">&quot;HANevse/resetOlimex&quot;</span>);</div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;                <a class="code" href="2020__photon__code_8cpp.html#adb31c248dea8d23a099aa0dad886c3a5">client</a>.subscribe(<span class="stringliteral">&quot;HANevse/resetPhoton&quot;</span>);</div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;                 <a class="code" href="2020__photon__code_8cpp.html#adb31c248dea8d23a099aa0dad886c3a5">client</a>.subscribe(<span class="stringliteral">&quot;HANevse/maxC3&quot;</span>);</div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;                 <a class="code" href="2020__photon__code_8cpp.html#adb31c248dea8d23a099aa0dad886c3a5">client</a>.subscribe(<span class="stringliteral">&quot;HANevse/maxC4&quot;</span>);</div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;                 <a class="code" href="2020__photon__code_8cpp.html#adb31c248dea8d23a099aa0dad886c3a5">client</a>.subscribe(<span class="stringliteral">&quot;HANevse/switchTest2&quot;</span>);</div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;            }</div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;            <span class="keywordflow">else</span> {</div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;                <a class="code" href="2020__photon__code_8cpp.html#acbc24b500df51b97ae92c398a78f2257">DEBUGPORT</a>.println(<span class="stringliteral">&quot;MQTT&gt;\tConnection failed&quot;</span>);</div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;                <a class="code" href="2020__photon__code_8cpp.html#acbc24b500df51b97ae92c398a78f2257">DEBUGPORT</a>.println(<span class="stringliteral">&quot;MQTT&gt;\tRetrying...&quot;</span>);</div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;                delay(10000);</div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;            }</div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;        }</div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;    }</div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;}</div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;</div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;<span class="comment">//! Inital setup for pin assignments and serial links start</span></div><div class="line"><a name="l00842"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#a4fc01d736fe50cf5b977f755b675f11d">  842</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="2020__photon__code_8cpp.html#a4fc01d736fe50cf5b977f755b675f11d">setup</a>() {</div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;    <a class="code" href="2020__photon__code_8cpp.html#acbc24b500df51b97ae92c398a78f2257">DEBUGPORT</a>.begin(115200);</div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;    Serial1.begin(9600);</div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;    <span class="comment">//DEBUGPORT.println(Voltage,5);</span></div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;    <span class="comment">//DEBUGPORT.println(String(Voltage,5));</span></div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;</div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;    waitUntil(Particle.connected);</div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;</div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;    pinMode(<a class="code" href="2020__photon__code_8cpp.html#ad9c4f7d10f64d91b939705d74023b303">AUTHENTICATION_CAR1</a>, OUTPUT); <span class="comment">//pinMode(D1, OUTPUT); //Charger1_Authorized</span></div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;    pinMode(<a class="code" href="2020__photon__code_8cpp.html#a2a2d5c06c6e46098cf951476de493799">AUTHENTICATION_CAR2</a>, OUTPUT); <span class="comment">//pinMode(D2, OUTPUT); //Charger2_Authorized</span></div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;    pinMode(<a class="code" href="2020__photon__code_8cpp.html#a17398a9ea4c977d65d45016629ac4b62">PILOT_FEEDBACK_CAR_1</a>,INPUT);</div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;    pinMode(<a class="code" href="2020__photon__code_8cpp.html#a5f0a51ff733ab3850f902312bc66e821">PILOT_FEEDBACK_CAR_2</a>,INPUT);</div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;    pinMode(<a class="code" href="2020__photon__code_8cpp.html#a67e476f839a040379490a06939ebac31">WAKEUP_OLIMEX</a>, OUTPUT);</div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;    pinMode(<a class="code" href="2020__photon__code_8cpp.html#ac12b65d6887bad87a0b5a519bba88dbe">RESET_OLIMEX</a>, OUTPUT);</div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;    pinMode(D7, OUTPUT);</div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;</div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;    digitalWrite(<a class="code" href="2020__photon__code_8cpp.html#ad9c4f7d10f64d91b939705d74023b303">AUTHENTICATION_CAR1</a>, LOW); <span class="comment">//digitalWrite(D1,LOW);</span></div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;    digitalWrite(<a class="code" href="2020__photon__code_8cpp.html#a2a2d5c06c6e46098cf951476de493799">AUTHENTICATION_CAR2</a>, LOW);<span class="comment">//digitalWrite(D2,LOW);</span></div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;    digitalWrite(<a class="code" href="2020__photon__code_8cpp.html#a67e476f839a040379490a06939ebac31">WAKEUP_OLIMEX</a>, LOW);</div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;    digitalWrite(<a class="code" href="2020__photon__code_8cpp.html#ac12b65d6887bad87a0b5a519bba88dbe">RESET_OLIMEX</a>, HIGH);</div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;    digitalWrite(D7, LOW);</div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;</div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;    <a class="code" href="2020__photon__code_8cpp.html#abc7cbbf081849eefdbf3b2a2a5b63151">initRFID</a><a class="code" href="2020__photon__code_8cpp.html#abc7cbbf081849eefdbf3b2a2a5b63151">(</a><span class="stringliteral">&quot;&quot;</span><a class="code" href="2020__photon__code_8cpp.html#abc7cbbf081849eefdbf3b2a2a5b63151">)</a>; <span class="comment">//+</span></div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;</div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;    <span class="comment">//Particle.process();  </span></div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;    <span class="comment">//resetOlimex(&quot;&quot;);  </span></div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;    <span class="comment">//Particle.process(); </span></div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;</div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;    Particle.function(<span class="stringliteral">&quot;switchTest&quot;</span>,switchTest);</div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;    Particle.function(<span class="stringliteral">&quot;maxCurrentC1&quot;</span>,maxCurrentC1);</div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;    Particle.function(<span class="stringliteral">&quot;maxCurrentC2&quot;</span>,maxCurrentC2);</div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;    Particle.function(<span class="stringliteral">&quot;resetOlimex&quot;</span>,resetOlimex);</div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;    Particle.function(<span class="stringliteral">&quot;progModeOlmx&quot;</span>,progModeOlmx);</div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;    Particle.function(<span class="stringliteral">&quot;resetParticl&quot;</span>,resetParticle);</div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;    <span class="comment">//Particle.function(&quot;AuthPinsHigh&quot;,AuthPinsHigh);</span></div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;    <span class="comment">//Particle.function(&quot;AuthPinsLow&quot;,AuthPinsLow);</span></div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;    Particle.function(<span class="stringliteral">&quot;WifiSignal&quot;</span>,WifiSignal);</div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;    Particle.function(<span class="stringliteral">&quot;initRFID&quot;</span>,initRFID);</div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;    Particle.variable(<span class="stringliteral">&quot;currentStr&quot;</span>,currentStr);</div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;    Particle.variable(<span class="stringliteral">&quot;ShareVar&quot;</span>,ShareVar);</div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;    <span class="comment">//Particle.variable(&quot;Current&quot;, Current_Str);</span></div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;    Particle.variable(<span class="stringliteral">&quot;Topic&quot;</span>, test);</div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;    Particle.process();</div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;</div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;    <span class="comment">//RGB.control(true);</span></div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;    Time.zone(1); <span class="comment">//Dutch time zone</span></div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;}</div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;</div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;<span class="comment">//! Main running function that executes all other functions; runs over 5times/second</span></div><div class="line"><a name="l00891"></a><span class="lineno"><a class="line" href="2020__photon__code_8cpp.html#afe461d27b9c48d5921c00d521181f12f">  891</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="2020__photon__code_8cpp.html#afe461d27b9c48d5921c00d521181f12f">loop</a>() {</div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;    <span class="comment">//Check the connection to the Particle server</span></div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;    <span class="keywordflow">if</span> (Particle.connected() == <span class="keyword">false</span>) {</div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;        Particle.connect();</div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;    }</div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;    <span class="comment">//Check the connection to the MQTT broker and let client take care of messages in buffers</span></div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="2020__photon__code_8cpp.html#adb31c248dea8d23a099aa0dad886c3a5">client</a>.isConnected()) {</div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;        <a class="code" href="2020__photon__code_8cpp.html#adb31c248dea8d23a099aa0dad886c3a5">client</a>.loop();</div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;    }</div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;    <span class="keywordflow">else</span> <a class="code" href="2020__photon__code_8cpp.html#a3b8259e6f263afa75396d3f65d194a92">reconnect</a><a class="code" href="2020__photon__code_8cpp.html#a3b8259e6f263afa75396d3f65d194a92">(</a><a class="code" href="2020__photon__code_8cpp.html#a3b8259e6f263afa75396d3f65d194a92">)</a>;</div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;</div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;    Particle.process();</div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;    <span class="comment">//currentStr = String(Current[0][0],1)+&quot; &quot;+String( Current[0][1],1)+&quot; &quot;+String(Current[0][2],1)+&quot; &quot;+String(Current[1][0],1)+&quot; &quot;+String( Current[1][1],1)+&quot; &quot;+String(Current[1][2],1)+&quot; &quot;+String(Frequency[0],2);</span></div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;<span class="comment">//+    currentStr = String(Current[0][0],1)+&quot; &quot;+String( PhaseVoltage[0][1],1)+&quot; &quot;+String(LineVoltage[0][2],1)+&quot; &quot;+String(Power[1][0],1)+&quot; &quot;+String( Energy[1],1)+&quot; &quot;+String(Current[1][2],1)+&quot; &quot;+String(Frequency[0],2);</span></div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;    <span class="comment">//currentStr=String(Current[1][2],1)+&quot; &quot;+currentStr.substring(0, max(200, currentStr.length()))</span></div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;    <span class="comment">//currentStr = String(CurrentList[0],1)+&quot; &quot;+String(CurrentList[1],1)+&quot; &quot;+String(CurrentList[2],1)+&quot; &quot;+String(CurrentList[3],1)+&quot; &quot;+String(CurrentList[4],1)+&quot; &quot;+String(CurrentList[5],1)+&quot; &quot;+String(CurrentList[6],1)+&quot; &quot;+String(CurrentList[7],1)+&quot; &quot;+String(CurrentList[8],1)+&quot; &quot;+String(CurrentList[9],1)+&quot; &quot;+String(CurrentList[10],1)+&quot; &quot;+String(CurrentList[11],1)+&quot; &quot;+String(CurrentList[12],1)+&quot; &quot;+String(CurrentList[13],1)+&quot; &quot;+String(CurrentList[14],1)+&quot; &quot;+String(CurrentList[15],1)+&quot; &quot;+String(CurrentList[16],1)+&quot; &quot;+String(CurrentList[17],1)+&quot; &quot;+String(CurrentList[18],1)+&quot; &quot;+String(CurrentList[19],1);</span></div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;</div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;    <span class="comment">//int Charger =1; //+</span></div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;</div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;    <span class="comment">//Read measurements from Olimex and save for which socket</span></div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;    <span class="keywordtype">int</span> Charger = <a class="code" href="_commandparser_8h.html#a37df00aa4f5618514442945d509f5029">readSerialOlimex</a><a class="code" href="_commandparser_8h.html#a37df00aa4f5618514442945d509f5029">(</a><a class="code" href="_commandparser_8h.html#a37df00aa4f5618514442945d509f5029">)</a> + <a class="code" href="2020__photon__code_8cpp.html#aff16429df21a43a886f66fdbc1e850a1">CHARGEROFFSET</a>;</div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;    Particle.process();</div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;    <span class="comment">// !!!! This runs multiple times a second for some reason (serial) </span></div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;    <span class="comment">// if(counter&gt;10){</span></div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;    <span class="comment">//  counter = 0;</span></div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;    <span class="comment">// !!!! DEBUGPORT.println(&quot;LatestStartTime&gt;\t&quot;+String(LatestStartTime[0])+&quot;, &quot;+String(LatestStartTime[1]));</span></div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;    <span class="comment">//  DEBUGPORT.println(String(Current[1][0]+ Current[1][1]+ Current[1][2]));</span></div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;    <span class="comment">// }</span></div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;    <span class="comment">// counter++;</span></div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;</div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;    <span class="comment">// store new measurement value if it is received correctly from energymeter (via the Olimex).</span></div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;    <span class="keywordflow">if</span>(millis()&gt;nextTime[handledCharger] &amp;&amp; (Charger==1+<a class="code" href="2020__photon__code_8cpp.html#aff16429df21a43a886f66fdbc1e850a1">CHARGEROFFSET</a> || Charger==2+<a class="code" href="2020__photon__code_8cpp.html#aff16429df21a43a886f66fdbc1e850a1">CHARGEROFFSET</a>))</div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;    {</div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;        Particle.process();</div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;        <span class="comment">//getUserIdAtSocket(Charger)</span></div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;        <span class="keywordtype">int</span> tempCharger = Charger;</div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;        Charger = <a class="code" href="2020__photon__code_8cpp.html#a9e450e39c6f4d83b30ab1c7baf55b308">handledCharger</a> + 1;</div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;        <span class="comment">//if(((activeCharger()==Charger) || (activeCharger() == 3)) &amp;&amp; (getUserIdAtSocket(Charger)!=&quot;00&quot;))</span></div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;        <span class="comment">//{</span></div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;            <span class="comment">//getUserIdAtSocket(Charger+CHARGEROFFSET);</span></div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;            add_Measurement(PhaseVoltage[Charger-1][0], PhaseVoltage[Charger-1][1], PhaseVoltage[Charger-1][2], Current[Charger-1][0], Current[Charger-1][1], Current[Charger-1][2], <span class="comment">/*Power[Charger-1][0]+Power[Charger-1][1]+Power[Charger-1][2], Energy[Charger-1],*/</span> Frequency[Charger-1], Time.now(), Charger+<a class="code" href="2020__photon__code_8cpp.html#aff16429df21a43a886f66fdbc1e850a1">CHARGEROFFSET</a>, getUserIdAtSocket(Charger+<a class="code" href="2020__photon__code_8cpp.html#aff16429df21a43a886f66fdbc1e850a1">CHARGEROFFSET</a>));</div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;        <span class="comment">//}</span></div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;        Charger = tempCharger;</div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;        nextTime[handledCharger] = millis() + 30000; <span class="comment">//every 30 sec</span></div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;    }</div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;</div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;<span class="comment">//     run loop very often to check new RFID cards</span></div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;    Particle.process(); <span class="comment">//+</span></div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;    <span class="keywordtype">bool</span> Authorized_Charger1=<a class="code" href="2020__photon__code_8cpp.html#a1b9d7ee6530be2853b10dee40dc3c02c">readRFIDCard</a><a class="code" href="2020__photon__code_8cpp.html#a1b9d7ee6530be2853b10dee40dc3c02c">(</a>1+<a class="code" href="2020__photon__code_8cpp.html#aff16429df21a43a886f66fdbc1e850a1">CHARGEROFFSET</a><a class="code" href="2020__photon__code_8cpp.html#a1b9d7ee6530be2853b10dee40dc3c02c">)</a>; <span class="comment">//+</span></div><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;    delay(5);</div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;    <span class="comment">//if (Pianswer == 1 || Pianswer ==4 )    </span></div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;    <span class="comment">//    Authorized_Charger1 = TRUE;</span></div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;    <span class="keywordtype">bool</span> Authorized_Charger2=<a class="code" href="2020__photon__code_8cpp.html#a1b9d7ee6530be2853b10dee40dc3c02c">readRFIDCard</a><a class="code" href="2020__photon__code_8cpp.html#a1b9d7ee6530be2853b10dee40dc3c02c">(</a>2+<a class="code" href="2020__photon__code_8cpp.html#aff16429df21a43a886f66fdbc1e850a1">CHARGEROFFSET</a><a class="code" href="2020__photon__code_8cpp.html#a1b9d7ee6530be2853b10dee40dc3c02c">)</a>; <span class="comment">//+</span></div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;    <span class="comment">//delay(5);</span></div><div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;    <span class="comment">//if (Pianswer == 1 || Pianswer ==4 )  //+    </span></div><div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;    <span class="comment">//      Authorized_Charger2 = TRUE;     //+</span></div><div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;</div><div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;</div><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;    <span class="comment">//DEBUGPORT.println(Current[0][0]+ Current[0][1]+ Current[0][2],4);</span></div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;    <span class="comment">//DEBUGPORT.println(String(LatestStartTime[0]+60));</span></div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;    <span class="comment">//DEBUGPORT.println(String(Time.now()));</span></div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;    <span class="comment">//DEBUGPORT.println((LatestStartTime[0] + 60 &lt; Time.now()),DEC);</span></div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;    <span class="comment">//if ((LatestStartTime[0] + 60 &lt; Time.now()) &amp;&amp; (Current[0][0]+ Current[0][1]+ Current[0][2]) &lt; 1)</span></div><div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;    <span class="comment">//if (((numberOfZeroReadings[0]&gt;10 &amp;&amp; (LatestStartTime[0] + 60 &lt; Time.now()))|| ((Time.now()&lt;LatestStartTime[0] + 70)&amp;&amp;(LatestStartTime[0] + 60 &lt; Time.now()))) &amp;&amp; (Current[0][0]+ Current[0][1]+ Current[0][2]) &lt; 1)</span></div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;</div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;    <span class="comment">// if 10+ Zero current readings have been taken or last start of new charge was over 1min ago and total Current is under 1A for first socket stop charge and reset StartTIme var</span></div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;    <span class="keywordflow">if</span>( (numberOfZeroReadings[0]&gt;10) &amp;&amp; (LatestStartTime[0] + 60 &lt; Time.now()) )</div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;    {</div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;        <span class="comment">//timeout with current almost zero</span></div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;        <a class="code" href="2020__photon__code_8cpp.html#acbc24b500df51b97ae92c398a78f2257">DEBUGPORT</a>.println(<span class="stringliteral">&quot;Timeout charger&quot;</span>+String(<a class="code" href="2020__photon__code_8cpp.html#aff16429df21a43a886f66fdbc1e850a1">CHARGEROFFSET</a>+1));</div><div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;        digitalWrite(<a class="code" href="2020__photon__code_8cpp.html#ad9c4f7d10f64d91b939705d74023b303">AUTHENTICATION_CAR1</a>,LOW);</div><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;        <a class="code" href="2020__photon__code_8cpp.html#ad9f162f714be8b69815d0a235c95c099">LatestStartTime</a>[0]=0;</div><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="2020__photon__code_8cpp.html#ad7696488afa62029edaf7487c0c32979">UIDtagCharger1</a><a class="code" href="class_string.html#aa3bec091af9c137939b348138ae06e93">!=</a><span class="stringliteral">&quot;No ID&quot;</span>){</div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;            <a class="code" href="class_json_writer_static.html">JsonWriterStatic</a>&lt;512&gt; jsonMessage;</div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;</div><div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;            {</div><div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;            <a class="code" href="class_json_writer_auto_object.html">JsonWriterAutoObject</a> obj(&amp;jsonMessage);</div><div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;</div><div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;            jsonMessage.insertKeyValue(<span class="stringliteral">&quot;UserId&quot;</span>, UIDtagCharger1);</div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;            jsonMessage.insertKeyValue(<span class="stringliteral">&quot;Charger&quot;</span>, (1 + <a class="code" href="2020__photon__code_8cpp.html#aff16429df21a43a886f66fdbc1e850a1">CHARGEROFFSET</a>));</div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;            jsonMessage.insertKeyValue(<span class="stringliteral">&quot;StartTime&quot;</span>, Time.now());</div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;            }</div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;            client.publish(<span class="stringliteral">&quot;HANevse/updateUser&quot;</span>, jsonMessage.getBuffer());</div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;</div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;            <a class="code" href="2020__photon__code_8cpp.html#ad7696488afa62029edaf7487c0c32979">UIDtagCharger1</a><a class="code" href="class_string.html#a0138caa55ac6d8b5bcd1fa7bb484a831">=</a><span class="stringliteral">&quot;No ID&quot;</span>;</div><div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;        }</div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;    }</div><div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;    <span class="comment">//DEBUGPORT.println(Current[1][0]+ Current[1][1]+ Current[1][2],4);</span></div><div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;    <span class="comment">//DEBUGPORT.println(String(LatestStartTime[1]+60));</span></div><div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;    <span class="comment">//DEBUGPORT.println(String(Time.now()));</span></div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;    <span class="comment">//DEBUGPORT.println((LatestStartTime[1] + 60 &lt; Time.now()),DEC);</span></div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;</div><div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;    <span class="comment">// if 10+ Zero current readings have been taken or last start of new charge was over 1min ago and total Current is under 1A for second socket stop charge and reset StartTIme var</span></div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;    <span class="keywordflow">if</span>( (numberOfZeroReadings[1]&gt;10) &amp;&amp; (LatestStartTime[1] + 60 &lt; Time.now()) )</div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;    {</div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;        <span class="comment">//timeout with current almost zero</span></div><div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;        <a class="code" href="2020__photon__code_8cpp.html#acbc24b500df51b97ae92c398a78f2257">DEBUGPORT</a>.println(<span class="stringliteral">&quot;Timeout charger&quot;</span>+String(<a class="code" href="2020__photon__code_8cpp.html#aff16429df21a43a886f66fdbc1e850a1">CHARGEROFFSET</a>+2));</div><div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;        digitalWrite(<a class="code" href="2020__photon__code_8cpp.html#a2a2d5c06c6e46098cf951476de493799">AUTHENTICATION_CAR2</a>,LOW);</div><div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;        <span class="comment">//digitalWrite(D7,LOW);</span></div><div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;        <a class="code" href="2020__photon__code_8cpp.html#ad9f162f714be8b69815d0a235c95c099">LatestStartTime</a>[1]=0;</div><div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="2020__photon__code_8cpp.html#ae42c45149b41b8f8cee744bb45a607ea">UIDtagCharger2</a><a class="code" href="class_string.html#aa3bec091af9c137939b348138ae06e93">!=</a><span class="stringliteral">&quot;No ID&quot;</span>){</div><div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;            <a class="code" href="class_json_writer_static.html">JsonWriterStatic</a>&lt;512&gt; jsonMessage;</div><div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;</div><div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;            {</div><div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;            <a class="code" href="class_json_writer_auto_object.html">JsonWriterAutoObject</a> obj(&amp;jsonMessage);</div><div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;</div><div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;            jsonMessage.insertKeyValue(<span class="stringliteral">&quot;UserId&quot;</span>, UIDtagCharger2);</div><div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;            jsonMessage.insertKeyValue(<span class="stringliteral">&quot;Charger&quot;</span>, (2 + <a class="code" href="2020__photon__code_8cpp.html#aff16429df21a43a886f66fdbc1e850a1">CHARGEROFFSET</a>));</div><div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;            jsonMessage.insertKeyValue(<span class="stringliteral">&quot;StartTime&quot;</span>, Time.now());</div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;            }</div><div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;            client.publish(<span class="stringliteral">&quot;HANevse/updateUser&quot;</span>, jsonMessage.getBuffer());</div><div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;</div><div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;            <a class="code" href="2020__photon__code_8cpp.html#ae42c45149b41b8f8cee744bb45a607ea">UIDtagCharger2</a><a class="code" href="class_string.html#a0138caa55ac6d8b5bcd1fa7bb484a831">=</a><span class="stringliteral">&quot;No ID&quot;</span>;</div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;            }</div><div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;</div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;    }</div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;    delay(100);</div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;</div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;</div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;    <span class="comment">//Reset the UIDtag if there is no car charging and last swipe was over 1min ago at first socket</span></div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;<span class="comment">//     if ((numberOfZeroReadings[0]&gt;10) &amp;&amp; (UIDtagCharger1!=&quot;No ID&quot;) &amp;&amp; (LatestStartTime[0] + 60 &lt; Time.now()) ){</span></div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;</div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;<span class="comment">//         JsonWriterStatic&lt;512&gt; jsonMessage;</span></div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;</div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;<span class="comment">//         {</span></div><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;<span class="comment">//      JsonWriterAutoObject obj(&amp;jsonMessage);</span></div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;</div><div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;<span class="comment">//      jsonMessage.insertKeyValue(&quot;UserId&quot;, UIDtagCharger1);</span></div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;<span class="comment">//         jsonMessage.insertKeyValue(&quot;Charger&quot;, (1 + CHARGEROFFSET));</span></div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;<span class="comment">//      jsonMessage.insertKeyValue(&quot;StartTime&quot;, Time.now());</span></div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;<span class="comment">//      }</span></div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;<span class="comment">//         client.publish(&quot;HANevse/updateUser&quot;, jsonMessage.getBuffer());</span></div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;</div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;<span class="comment">//         UIDtagCharger1=&quot;No ID&quot;;</span></div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;<span class="comment">//     }</span></div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;</div><div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;</div><div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;<span class="comment">//     if ((numberOfZeroReadings[0]&gt;10) &amp;&amp; (UIDtagCharger2!=&quot;No ID&quot;) &amp;&amp; (LatestStartTime[1] + 60 &lt; Time.now()) ){</span></div><div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;</div><div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;<span class="comment">//         JsonWriterStatic&lt;512&gt; jsonMessage;</span></div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;</div><div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;<span class="comment">//         {</span></div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;<span class="comment">//      JsonWriterAutoObject obj(&amp;jsonMessage);</span></div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;</div><div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;<span class="comment">//      jsonMessage.insertKeyValue(&quot;UserId&quot;, UIDtagCharger2);</span></div><div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;<span class="comment">//         jsonMessage.insertKeyValue(&quot;Charger&quot;, (2 + CHARGEROFFSET));</span></div><div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;<span class="comment">//      jsonMessage.insertKeyValue(&quot;StartTime&quot;, Time.now());</span></div><div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;<span class="comment">//      }</span></div><div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;<span class="comment">//         client.publish(&quot;HANevse/updateUser&quot;, jsonMessage.getBuffer());</span></div><div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;</div><div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;<span class="comment">//         UIDtagCharger2=&quot;No ID&quot;;</span></div><div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;<span class="comment">//     }</span></div><div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;</div><div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;    <a class="code" href="2020__photon__code_8cpp.html#a9e450e39c6f4d83b30ab1c7baf55b308">handledCharger</a> = !<a class="code" href="2020__photon__code_8cpp.html#a9e450e39c6f4d83b30ab1c7baf55b308">handledCharger</a>;</div><div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;}</div><div class="ttc" id="2020__photon__code_8cpp_html_ad7dc0d6376ca803542168e9adc0dec79"><div class="ttname"><a href="2020__photon__code_8cpp.html#ad7dc0d6376ca803542168e9adc0dec79">progModeOlmx</a></div><div class="ttdeci">int progModeOlmx(String input)</div><div class="ttdoc">Sets Olimex into programming mode. </div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00174">2020_photon_code.cpp:174</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_a1e87c855c31041a5f4bca41f110ecb23"><div class="ttname"><a href="2020__photon__code_8cpp.html#a1e87c855c31041a5f4bca41f110ecb23">SS_PIN_CHARGER1</a></div><div class="ttdeci">#define SS_PIN_CHARGER1</div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00070">2020_photon_code.cpp:70</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_aff16429df21a43a886f66fdbc1e850a1"><div class="ttname"><a href="2020__photon__code_8cpp.html#aff16429df21a43a886f66fdbc1e850a1">CHARGEROFFSET</a></div><div class="ttdeci">#define CHARGEROFFSET</div><div class="ttdoc">constant that sets for which Photon this program is intended </div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00064">2020_photon_code.cpp:64</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_afe461d27b9c48d5921c00d521181f12f"><div class="ttname"><a href="2020__photon__code_8cpp.html#afe461d27b9c48d5921c00d521181f12f">loop</a></div><div class="ttdeci">void loop()</div><div class="ttdoc">Main running function that executes all other functions; runs over 5times/second. ...</div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00891">2020_photon_code.cpp:891</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_ae42c45149b41b8f8cee744bb45a607ea"><div class="ttname"><a href="2020__photon__code_8cpp.html#ae42c45149b41b8f8cee744bb45a607ea">UIDtagCharger2</a></div><div class="ttdeci">String UIDtagCharger2</div><div class="ttdoc">var to hold valid RFID tag at second socket (used for Measurements) </div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00058">2020_photon_code.cpp:58</a></div></div>
<div class="ttc" id="class_string_html_a36b10b81c1556de6e5c63fd060347f30"><div class="ttname"><a href="class_string.html#a36b10b81c1556de6e5c63fd060347f30">String::substring</a></div><div class="ttdeci">String substring(unsigned int beginIndex) const</div><div class="ttdoc">Returns a String object with a copy of the characters starting at beginIndex through the end of the s...</div><div class="ttdef"><b>Definition:</b> <a href="spark__wiring__string_8cpp_source.html#l00612">spark_wiring_string.cpp:612</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_a5cb1ec604593003ff86b9e36162aeb1a"><div class="ttname"><a href="2020__photon__code_8cpp.html#a5cb1ec604593003ff86b9e36162aeb1a">SS_PIN_CHARGER2</a></div><div class="ttdeci">#define SS_PIN_CHARGER2</div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00071">2020_photon_code.cpp:71</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_a4183b3a07abe46eb609ddd3bbc39ce3c"><div class="ttname"><a href="2020__photon__code_8cpp.html#a4183b3a07abe46eb609ddd3bbc39ce3c">latestUID2</a></div><div class="ttdeci">String latestUID2</div><div class="ttdoc">var to hold last swiped RFID tag at second socket </div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00054">2020_photon_code.cpp:54</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_acbc24b500df51b97ae92c398a78f2257"><div class="ttname"><a href="2020__photon__code_8cpp.html#acbc24b500df51b97ae92c398a78f2257">DEBUGPORT</a></div><div class="ttdeci">#define DEBUGPORT</div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00065">2020_photon_code.cpp:65</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_a1b9d7ee6530be2853b10dee40dc3c02c"><div class="ttname"><a href="2020__photon__code_8cpp.html#a1b9d7ee6530be2853b10dee40dc3c02c">readRFIDCard</a></div><div class="ttdeci">bool readRFIDCard(int Charger)</div><div class="ttdoc">Checks and reads RFID tag at the asked socket, then MQTT publishes it for Pi. </div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00590">2020_photon_code.cpp:590</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_a2a2d5c06c6e46098cf951476de493799"><div class="ttname"><a href="2020__photon__code_8cpp.html#a2a2d5c06c6e46098cf951476de493799">AUTHENTICATION_CAR2</a></div><div class="ttdeci">#define AUTHENTICATION_CAR2</div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00082">2020_photon_code.cpp:82</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_ac12b65d6887bad87a0b5a519bba88dbe"><div class="ttname"><a href="2020__photon__code_8cpp.html#ac12b65d6887bad87a0b5a519bba88dbe">RESET_OLIMEX</a></div><div class="ttdeci">#define RESET_OLIMEX</div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00078">2020_photon_code.cpp:78</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_a17398a9ea4c977d65d45016629ac4b62"><div class="ttname"><a href="2020__photon__code_8cpp.html#a17398a9ea4c977d65d45016629ac4b62">PILOT_FEEDBACK_CAR_1</a></div><div class="ttdeci">#define PILOT_FEEDBACK_CAR_1</div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00079">2020_photon_code.cpp:79</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_ad7696488afa62029edaf7487c0c32979"><div class="ttname"><a href="2020__photon__code_8cpp.html#ad7696488afa62029edaf7487c0c32979">UIDtagCharger1</a></div><div class="ttdeci">String UIDtagCharger1</div><div class="ttdoc">var to hold valid RFID tag at first socket (used for Measurements) </div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00056">2020_photon_code.cpp:56</a></div></div>
<div class="ttc" id="_commandparser_8h_html_ab804d1dfcf90d1a4adf1b6417583e014"><div class="ttname"><a href="_commandparser_8h.html#ab804d1dfcf90d1a4adf1b6417583e014">numberOfZeroReadings</a></div><div class="ttdeci">int numberOfZeroReadings[2]</div><div class="ttdef"><b>Definition:</b> <a href="_commandparser_8h_source.html#l00037">Commandparser.h:37</a></div></div>
<div class="ttc" id="class_json_writer_static_html"><div class="ttname"><a href="class_json_writer_static.html">JsonWriterStatic</a></div><div class="ttdoc">Creates a JsonWriter with a statically allocated buffer. </div><div class="ttdef"><b>Definition:</b> <a href="_json_parser_generator_r_k_8h_source.html#l01241">JsonParserGeneratorRK.h:1241</a></div></div>
<div class="ttc" id="_commandparser_8h_html_ae0a1c20c390eb592307c92aa588bd232"><div class="ttname"><a href="_commandparser_8h.html#ae0a1c20c390eb592307c92aa588bd232">Power</a></div><div class="ttdeci">float Power[2][3]</div><div class="ttdef"><b>Definition:</b> <a href="_commandparser_8h_source.html#l00031">Commandparser.h:31</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_aee241410f32d11f903417e0eb68d4bec"><div class="ttname"><a href="2020__photon__code_8cpp.html#aee241410f32d11f903417e0eb68d4bec">add_Measurement</a></div><div class="ttdeci">void add_Measurement(float phaseVoltageL1, float phaseVoltageL2, float phaseVoltageL3, float currentL1, float currentL2, float currentL3, float Frequency, unsigned long Timestamp, int socketId=0, String userId=&quot;00&quot;)</div><div class="ttdoc">Function ran for each socket every 30s in main loop to send measurements through MQTT. </div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00519">2020_photon_code.cpp:519</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_aa30c831d7117c1442287526570a90c20"><div class="ttname"><a href="2020__photon__code_8cpp.html#aa30c831d7117c1442287526570a90c20">latestUID1</a></div><div class="ttdeci">String latestUID1</div><div class="ttdoc">var to hold last swiped RFID tag at first socket </div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00052">2020_photon_code.cpp:52</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_a4c5d5ea4f6d4b65954431d96e299d9bf"><div class="ttname"><a href="2020__photon__code_8cpp.html#a4c5d5ea4f6d4b65954431d96e299d9bf">charToString</a></div><div class="ttdeci">void charToString(const char in[], String &amp;out)</div><div class="ttdoc">Deprecated function to convert char to String - the String class already has one. ...</div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00145">2020_photon_code.cpp:145</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_a4e589466e8ba636e450e90122ed59185"><div class="ttname"><a href="2020__photon__code_8cpp.html#a4e589466e8ba636e450e90122ed59185">nextTime</a></div><div class="ttdeci">unsigned int nextTime[2]</div><div class="ttdoc">Next timestamp to publish measurements in ms. </div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00142">2020_photon_code.cpp:142</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_a4fc01d736fe50cf5b977f755b675f11d"><div class="ttname"><a href="2020__photon__code_8cpp.html#a4fc01d736fe50cf5b977f755b675f11d">setup</a></div><div class="ttdeci">void setup()</div><div class="ttdoc">Inital setup for pin assignments and serial links start. </div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00842">2020_photon_code.cpp:842</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_ac3a129f66dc859e2b7279565f4e1de78"><div class="ttname"><a href="2020__photon__code_8cpp.html#ac3a129f66dc859e2b7279565f4e1de78">callback</a></div><div class="ttdeci">void callback(char *topic, byte *payload, unsigned int length)</div><div class="ttdoc">Main function for MQTT client to check for new messages and execute callback functions. </div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00683">2020_photon_code.cpp:683</a></div></div>
<div class="ttc" id="_commandparser_8h_html_a5455bcadf3414330eeedd39d97e8aee2"><div class="ttname"><a href="_commandparser_8h.html#a5455bcadf3414330eeedd39d97e8aee2">PhaseVoltage</a></div><div class="ttdeci">float PhaseVoltage[2][3]</div><div class="ttdef"><b>Definition:</b> <a href="_commandparser_8h_source.html#l00032">Commandparser.h:32</a></div></div>
<div class="ttc" id="class_string_html_a70b3aba8ac7a57e3bb48a52a5d64a88b"><div class="ttname"><a href="class_string.html#a70b3aba8ac7a57e3bb48a52a5d64a88b">String::operator=</a></div><div class="ttdeci">String &amp; operator=(const String &amp;rhs)</div><div class="ttdoc">Assigns this string to have a copy of String rhs. </div><div class="ttdef"><b>Definition:</b> <a href="spark__wiring__string_8cpp_source.html#l00240">spark_wiring_string.cpp:240</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_a3dfbf949915a0daa4ff676106f605085"><div class="ttname"><a href="2020__photon__code_8cpp.html#a3dfbf949915a0daa4ff676106f605085">mfrc522_Charger2</a></div><div class="ttdeci">MFRC522 mfrc522_Charger2(SS_PIN_CHARGER2, RST_PIN)</div></div>
<div class="ttc" id="_commandparser_8h_html_a37df00aa4f5618514442945d509f5029"><div class="ttname"><a href="_commandparser_8h.html#a37df00aa4f5618514442945d509f5029">readSerialOlimex</a></div><div class="ttdeci">int readSerialOlimex()</div><div class="ttdef"><b>Definition:</b> <a href="_commandparser_8h_source.html#l00273">Commandparser.h:273</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_aec0df453c6114acf2314a61fa0879eb7"><div class="ttname"><a href="2020__photon__code_8cpp.html#aec0df453c6114acf2314a61fa0879eb7">maxCurrentC2_test</a></div><div class="ttdeci">int maxCurrentC2_test(unsigned int setPoint)</div><div class="ttdoc">Sets max Current output at socket 2/4 in renewable mode and publishes new setpoint at &quot;HANevse/photon...</div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00278">2020_photon_code.cpp:278</a></div></div>
<div class="ttc" id="class_string_html_a6d437a7312b591848b5457705fee5549"><div class="ttname"><a href="class_string.html#a6d437a7312b591848b5457705fee5549">String::concat</a></div><div class="ttdeci">unsigned char concat(int num)</div><div class="ttdoc">Append (concatenate) the integer value num to the end of this String as a signed decimal number (base...</div><div class="ttdef"><b>Definition:</b> <a href="spark__wiring__string_8cpp_source.html#l00313">spark_wiring_string.cpp:313</a></div></div>
<div class="ttc" id="class_json_parser_html_ad528213e8600cbad4d85910b62fc033a"><div class="ttname"><a href="class_json_parser.html#ad528213e8600cbad4d85910b62fc033a">JsonParser::parse</a></div><div class="ttdeci">bool parse()</div><div class="ttdoc">Parses the data you have added using addData() or addString(). </div><div class="ttdef"><b>Definition:</b> <a href="_json_parser_generator_r_k_8cpp_source.html#l00118">JsonParserGeneratorRK.cpp:118</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_a3019b040c98717baa7b6048ac7a35dd7"><div class="ttname"><a href="2020__photon__code_8cpp.html#a3019b040c98717baa7b6048ac7a35dd7">allowUser_callback</a></div><div class="ttdeci">void allowUser_callback(byte *payload, unsigned int length)</div><div class="ttdoc">Callback function to process and execute approval or denial to charge from Pi, then MQTT publish reas...</div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00443">2020_photon_code.cpp:443</a></div></div>
<div class="ttc" id="class_string_html_ad453b9631caf5d0164ae493bf1aa9680"><div class="ttname"><a href="class_string.html#ad453b9631caf5d0164ae493bf1aa9680">String::operator==</a></div><div class="ttdeci">unsigned char operator==(const char *cstr) const</div><div class="ttdoc">Returns true if this string equal to another string (case-sensitive) </div><div class="ttdef"><b>Definition:</b> <a href="docs_2src_2spark__wiring__string_8h_source.html#l00597">spark_wiring_string.h:597</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_a617a47c70795bcff659815ad0efd2266"><div class="ttname"><a href="2020__photon__code_8cpp.html#a617a47c70795bcff659815ad0efd2266">counter</a></div><div class="ttdeci">int counter</div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00101">2020_photon_code.cpp:101</a></div></div>
<div class="ttc" id="class_json_buffer_html_a70969847d857815a9ded6450378e0e53"><div class="ttname"><a href="class_json_buffer.html#a70969847d857815a9ded6450378e0e53">JsonBuffer::clear</a></div><div class="ttdeci">void clear()</div><div class="ttdoc">Clears the current buffer for writing. </div><div class="ttdef"><b>Definition:</b> <a href="_json_parser_generator_r_k_8cpp_source.html#l00062">JsonParserGeneratorRK.cpp:62</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_adb31c248dea8d23a099aa0dad886c3a5"><div class="ttname"><a href="2020__photon__code_8cpp.html#adb31c248dea8d23a099aa0dad886c3a5">client</a></div><div class="ttdeci">MQTT client(&quot;broker.hivemq.com&quot;, 1883, MQTT_DEFAULT_KEEPALIVE, callback, 512)</div><div class="ttdoc">MQTT client details; do not set last number to over 512! </div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_ad62b79073819df234fbe97fd477a2c83"><div class="ttname"><a href="2020__photon__code_8cpp.html#ad62b79073819df234fbe97fd477a2c83">resetParticle</a></div><div class="ttdeci">int resetParticle(String input)</div><div class="ttdoc">Resets Photon. </div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00169">2020_photon_code.cpp:169</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_a36932b0e869e0114f32e255f61306d6b"><div class="ttname"><a href="2020__photon__code_8cpp.html#a36932b0e869e0114f32e255f61306d6b">RST_PIN</a></div><div class="ttdeci">#define RST_PIN</div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00072">2020_photon_code.cpp:72</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_ad474dc90a6ac368a5be5a4e0d333c8b1"><div class="ttname"><a href="2020__photon__code_8cpp.html#ad474dc90a6ac368a5be5a4e0d333c8b1">STARTUP</a></div><div class="ttdeci">STARTUP(WiFi.selectAntenna(ANT_EXTERNAL))</div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_a18aecc3313a2e8b7a2a4d49759585f63"><div class="ttname"><a href="2020__photon__code_8cpp.html#a18aecc3313a2e8b7a2a4d49759585f63">activeCharger</a></div><div class="ttdeci">int activeCharger()</div><div class="ttdoc">Return 1 if socket 1 is used, 2 if socket 2 is used, and 3 if both are in use. </div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00200">2020_photon_code.cpp:200</a></div></div>
<div class="ttc" id="class_m_f_r_c522_html"><div class="ttname"><a href="class_m_f_r_c522.html">MFRC522</a></div><div class="ttdef"><b>Definition:</b> <a href="_m_f_r_c522_8h_source.html#l00086">MFRC522.h:86</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_aea090791790fbe9e0f56d324c8eefa80"><div class="ttname"><a href="2020__photon__code_8cpp.html#aea090791790fbe9e0f56d324c8eefa80">resetOlimex</a></div><div class="ttdeci">int resetOlimex(String input)</div><div class="ttdoc">Sends reset signal to EV charger controller. </div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00156">2020_photon_code.cpp:156</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_a3cc9a3f799bf2e4bf1b63ee7367911cb"><div class="ttname"><a href="2020__photon__code_8cpp.html#a3cc9a3f799bf2e4bf1b63ee7367911cb">currentStr</a></div><div class="ttdeci">String currentStr</div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00140">2020_photon_code.cpp:140</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_abc7cbbf081849eefdbf3b2a2a5b63151"><div class="ttname"><a href="2020__photon__code_8cpp.html#abc7cbbf081849eefdbf3b2a2a5b63151">initRFID</a></div><div class="ttdeci">int initRFID(String input)</div><div class="ttdoc">Initialises RFID reader. </div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00567">2020_photon_code.cpp:567</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_a3f4173fd4828d1d948935a30e1841263"><div class="ttname"><a href="2020__photon__code_8cpp.html#a3f4173fd4828d1d948935a30e1841263">test</a></div><div class="ttdeci">String test</div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00098">2020_photon_code.cpp:98</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_ad9f162f714be8b69815d0a235c95c099"><div class="ttname"><a href="2020__photon__code_8cpp.html#ad9f162f714be8b69815d0a235c95c099">LatestStartTime</a></div><div class="ttdeci">unsigned long LatestStartTime[2]</div><div class="ttdoc">Holds latest start of new charge if charger is in use. </div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00105">2020_photon_code.cpp:105</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_a9e8e91d801c5f9812d2862fcc94153b3"><div class="ttname"><a href="2020__photon__code_8cpp.html#a9e8e91d801c5f9812d2862fcc94153b3">getUserIdAtSocket</a></div><div class="ttdeci">String getUserIdAtSocket(int socket)</div><div class="ttdoc">Returns RFID tag at the asked socket. </div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00312">2020_photon_code.cpp:312</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_a9e450e39c6f4d83b30ab1c7baf55b308"><div class="ttname"><a href="2020__photon__code_8cpp.html#a9e450e39c6f4d83b30ab1c7baf55b308">handledCharger</a></div><div class="ttdeci">bool handledCharger</div><div class="ttdoc">Holds last handled socket (0 for first socket) </div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00107">2020_photon_code.cpp:107</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_a1777032818666232368a054cc7cc76f8"><div class="ttname"><a href="2020__photon__code_8cpp.html#a1777032818666232368a054cc7cc76f8">mfrc522_Charger1</a></div><div class="ttdeci">MFRC522 mfrc522_Charger1(SS_PIN_CHARGER1, RST_PIN)</div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_a3b8259e6f263afa75396d3f65d194a92"><div class="ttname"><a href="2020__photon__code_8cpp.html#a3b8259e6f263afa75396d3f65d194a92">reconnect</a></div><div class="ttdeci">void reconnect(void)</div><div class="ttdoc">Function to reconnect to MQTT server if not connected and subscribe to needed topics. </div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00797">2020_photon_code.cpp:797</a></div></div>
<div class="ttc" id="_commandparser_8h_html_ac7a5502c6bab0b1b7f3e1bd58546eb1e"><div class="ttname"><a href="_commandparser_8h.html#ac7a5502c6bab0b1b7f3e1bd58546eb1e">Current</a></div><div class="ttdeci">float Current[2][3]</div><div class="ttdef"><b>Definition:</b> <a href="_commandparser_8h_source.html#l00030">Commandparser.h:30</a></div></div>
<div class="ttc" id="class_json_writer_auto_object_html"><div class="ttname"><a href="class_json_writer_auto_object.html">JsonWriterAutoObject</a></div><div class="ttdoc">Class for creating a JSON object with JsonWriter. </div><div class="ttdef"><b>Definition:</b> <a href="_json_parser_generator_r_k_8h_source.html#l01256">JsonParserGeneratorRK.h:1256</a></div></div>
<div class="ttc" id="class_json_parser_html"><div class="ttname"><a href="class_json_parser.html">JsonParser</a></div><div class="ttdoc">API to the JsonParser. </div><div class="ttdef"><b>Definition:</b> <a href="_json_parser_generator_r_k_8h_source.html#l00262">JsonParserGeneratorRK.h:262</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_adc2cf5dea5b7775d53532f2ccfa10f4c"><div class="ttname"><a href="2020__photon__code_8cpp.html#adc2cf5dea5b7775d53532f2ccfa10f4c">WifiSignal</a></div><div class="ttdeci">int WifiSignal(String input)</div><div class="ttdoc">Return wifi strength. </div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00164">2020_photon_code.cpp:164</a></div></div>
<div class="ttc" id="_commandparser_8h_html_aee63a73e17fd417c7562f2e5d7c81cb8"><div class="ttname"><a href="_commandparser_8h.html#aee63a73e17fd417c7562f2e5d7c81cb8">Energy</a></div><div class="ttdeci">float Energy[2]</div><div class="ttdef"><b>Definition:</b> <a href="_commandparser_8h_source.html#l00034">Commandparser.h:34</a></div></div>
<div class="ttc" id="class_string_html_a2dc5a9a787f8ff266d1130594ec65237"><div class="ttname"><a href="class_string.html#a2dc5a9a787f8ff266d1130594ec65237">String::toInt</a></div><div class="ttdeci">long toInt(void) const</div><div class="ttdoc">Converts this string to a signed integer (32-bit) </div><div class="ttdef"><b>Definition:</b> <a href="spark__wiring__string_8cpp_source.html#l00744">spark_wiring_string.cpp:744</a></div></div>
<div class="ttc" id="_m_q_t_t_8h_html_a4f9ba980ddfd73b1a40c3513d8c5d0dd"><div class="ttname"><a href="_m_q_t_t_8h.html#a4f9ba980ddfd73b1a40c3513d8c5d0dd">MQTT_DEFAULT_KEEPALIVE</a></div><div class="ttdeci">#define MQTT_DEFAULT_KEEPALIVE</div><div class="ttdef"><b>Definition:</b> <a href="_m_q_t_t_8h_source.html#l00076">MQTT.h:76</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_a63ba3c80c4eecc57f8ee73e2045b372f"><div class="ttname"><a href="2020__photon__code_8cpp.html#a63ba3c80c4eecc57f8ee73e2045b372f">getMeasure_callback</a></div><div class="ttdeci">void getMeasure_callback(byte *payload, unsigned int length)</div><div class="ttdoc">Callback function to automatically set max Currents from MQTT message if in renewable mode...</div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00321">2020_photon_code.cpp:321</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_abc87df2ac47aa12b30692fd38255d367"><div class="ttname"><a href="2020__photon__code_8cpp.html#abc87df2ac47aa12b30692fd38255d367">ShareVar</a></div><div class="ttdeci">String ShareVar</div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00108">2020_photon_code.cpp:108</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_a570e0c09591b015ae3748de87e467b9f"><div class="ttname"><a href="2020__photon__code_8cpp.html#a570e0c09591b015ae3748de87e467b9f">TESTCASE</a></div><div class="ttdeci">bool TESTCASE</div><div class="ttdoc">var that holds the charging mode (TRUE = renewable) </div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00112">2020_photon_code.cpp:112</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_a5f0a51ff733ab3850f902312bc66e821"><div class="ttname"><a href="2020__photon__code_8cpp.html#a5f0a51ff733ab3850f902312bc66e821">PILOT_FEEDBACK_CAR_2</a></div><div class="ttdeci">#define PILOT_FEEDBACK_CAR_2</div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00080">2020_photon_code.cpp:80</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_a33435c28a8a11141750280aec8f15cbd"><div class="ttname"><a href="2020__photon__code_8cpp.html#a33435c28a8a11141750280aec8f15cbd">maxCurrentC2</a></div><div class="ttdeci">int maxCurrentC2(String setPointStr)</div><div class="ttdoc">Sets max Current output at socket 2 in manual mode. </div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00248">2020_photon_code.cpp:248</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_a0cb29d1e3bc87d74d13737e494738243"><div class="ttname"><a href="2020__photon__code_8cpp.html#a0cb29d1e3bc87d74d13737e494738243">Pianswer</a></div><div class="ttdeci">ushort Pianswer</div><div class="ttdoc">var that holds answer from Pi but is unused now </div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00115">2020_photon_code.cpp:115</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_ad0790b5517da1ecc7d9b128f1c5876a5"><div class="ttname"><a href="2020__photon__code_8cpp.html#ad0790b5517da1ecc7d9b128f1c5876a5">switchTest</a></div><div class="ttdeci">int switchTest(String valueString)</div><div class="ttdoc">Switches between renewable mode (-input &quot;true&quot;) and manual setpoint mode. </div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00220">2020_photon_code.cpp:220</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_acd7da18abdd273f892ec13cb726810b6"><div class="ttname"><a href="2020__photon__code_8cpp.html#acd7da18abdd273f892ec13cb726810b6">blinkRFIDled</a></div><div class="ttdeci">void blinkRFIDled(int charger, int action)</div><div class="ttdoc">unused function to blink the Photon LED </div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00184">2020_photon_code.cpp:184</a></div></div>
<div class="ttc" id="class_string_html"><div class="ttname"><a href="class_string.html">String</a></div><div class="ttdoc">Wiring String: A class to hold and manipulate a dynamically allocated string. </div><div class="ttdef"><b>Definition:</b> <a href="docs_2src_2spark__wiring__string_8h_source.html#l00054">spark_wiring_string.h:54</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_a67e476f839a040379490a06939ebac31"><div class="ttname"><a href="2020__photon__code_8cpp.html#a67e476f839a040379490a06939ebac31">WAKEUP_OLIMEX</a></div><div class="ttdeci">#define WAKEUP_OLIMEX</div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00077">2020_photon_code.cpp:77</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_acb83be59c559528f5aff6a05e307aba0"><div class="ttname"><a href="2020__photon__code_8cpp.html#acb83be59c559528f5aff6a05e307aba0">maxCurrentC1_test</a></div><div class="ttdeci">int maxCurrentC1_test(unsigned int setPoint)</div><div class="ttdoc">Sets max Current output at socket 1/3 in renewable mode and publishes new setpoint at &quot;HANevse/photon...</div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00262">2020_photon_code.cpp:262</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_aa95a87dbf10d08c2472e2060115a786d"><div class="ttname"><a href="2020__photon__code_8cpp.html#aa95a87dbf10d08c2472e2060115a786d">maxCurrentC1</a></div><div class="ttdeci">int maxCurrentC1(String setPointStr)</div><div class="ttdoc">Sets max Current output at socket 1 in manual mode. </div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00234">2020_photon_code.cpp:234</a></div></div>
<div class="ttc" id="_commandparser_8h_html_ad8ee7ca82dcb110d2d5e32d73116b001"><div class="ttname"><a href="_commandparser_8h.html#ad8ee7ca82dcb110d2d5e32d73116b001">Frequency</a></div><div class="ttdeci">float Frequency[2]</div><div class="ttdef"><b>Definition:</b> <a href="_commandparser_8h_source.html#l00035">Commandparser.h:35</a></div></div>
<div class="ttc" id="_commandparser_8h_html_a97cf7b62d84c77183146053465157cdc"><div class="ttname"><a href="_commandparser_8h.html#a97cf7b62d84c77183146053465157cdc">LineVoltage</a></div><div class="ttdeci">float LineVoltage[2][3]</div><div class="ttdef"><b>Definition:</b> <a href="_commandparser_8h_source.html#l00033">Commandparser.h:33</a></div></div>
<div class="ttc" id="class_string_html_aa3bec091af9c137939b348138ae06e93"><div class="ttname"><a href="class_string.html#aa3bec091af9c137939b348138ae06e93">String::operator!=</a></div><div class="ttdeci">unsigned char operator!=(const char *cstr) const</div><div class="ttdoc">Returns true if this string not equal to another string (case-sensitive) </div><div class="ttdef"><b>Definition:</b> <a href="docs_2src_2spark__wiring__string_8h_source.html#l00622">spark_wiring_string.h:622</a></div></div>
<div class="ttc" id="class_string_html_a53134e2b38eb0d114f886e807a3753ae"><div class="ttname"><a href="class_string.html#a53134e2b38eb0d114f886e807a3753ae">String::String</a></div><div class="ttdeci">String(unsigned int value, unsigned char base=10)</div><div class="ttdoc">Construct a String from a unsigned int (32 bit unsigned integer) value, expressed as a number...</div><div class="ttdef"><b>Definition:</b> <a href="spark__wiring__string_8cpp_source.html#l00119">spark_wiring_string.cpp:119</a></div></div>
<div class="ttc" id="_commandparser_8h_html_acd950d6d9d76947b74823343a5f4a25d"><div class="ttname"><a href="_commandparser_8h.html#acd950d6d9d76947b74823343a5f4a25d">CurrentList</a></div><div class="ttdeci">float CurrentList[20]</div><div class="ttdef"><b>Definition:</b> <a href="_commandparser_8h_source.html#l00036">Commandparser.h:36</a></div></div>
<div class="ttc" id="2020__photon__code_8cpp_html_ad9c4f7d10f64d91b939705d74023b303"><div class="ttname"><a href="2020__photon__code_8cpp.html#ad9c4f7d10f64d91b939705d74023b303">AUTHENTICATION_CAR1</a></div><div class="ttdeci">#define AUTHENTICATION_CAR1</div><div class="ttdef"><b>Definition:</b> <a href="2020__photon__code_8cpp_source.html#l00081">2020_photon_code.cpp:81</a></div></div>
<div class="ttc" id="class_string_html_a0138caa55ac6d8b5bcd1fa7bb484a831"><div class="ttname"><a href="class_string.html#a0138caa55ac6d8b5bcd1fa7bb484a831">String::operator=</a></div><div class="ttdeci">String &amp; operator=(const char *cstr)</div><div class="ttdoc">Assigns this string to have a copy of c-string (null-terminated) cstr. </div><div class="ttdef"><b>Definition:</b> <a href="spark__wiring__string_8cpp_source.html#l00264">spark_wiring_string.cpp:264</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="2020__photon__code_8cpp.html">2020_photon_code.cpp</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
